---
title: "Does protected area connectivity moderate the efficacy of protection on tropical biodiversity? Evidence from a replication of Brodie et al. 2023"
author: "Peter Kedron, Lei Song, Wenxin Yang, Amy Frazier"
date: "`r Sys.Date()`"
output: 
  pdf_document:
    toc: false
    number_sections: true
editor_options:
  markdown:
    wrap: sentence
knit: (function(inputFile, encoding) {
  rmarkdown::render(inputFile, encoding = encoding, output_dir = "../../docs/report") })
---
```{r chunk setup, include = FALSE, message = FALSE}
# record all the packages you are using here
# this includes any calls to library(), require(),
# and double colons such as here::i_am()
packages <- c("tidyverse", "here")

# force all conflicts to become errors
require(conflicted)
library(here)

# load and install required packages
# https://groundhogr.com/
if (!require(groundhog)) {
  install.packages("groundhog")
  require(groundhog)
}

# record the R processing environment
writeLines(
  capture.output(sessionInfo()),
  here("procedure", "environment", paste0("r-environment-", Sys.Date(), ".txt"))
)

# save package citations
knitr::write_bib(c(packages, "base"), file = here("software.bib"))

# set up default knitr parameters
# https://yihui.org/knitr/options/
knitr::opts_chunk$set(
  echo = FALSE, # Run code, show outputs (don't show code)
  fig.retina = 4,
  fig.width = 8,
  fig.path = paste0(here("results", "figures"), "/"),
  warning = FALSE,
  message = FALSE
)

# set working directory as the project folder
knitr::opts_knit$set(root.dir = here(''))
options(tinytex.verbose = TRUE)
```

# Introduction
This study is a *computational reproduction* of:

> Brodie, J.F., Mohd-Azlan, J., Chen, C. et al. Landscape-scale benefits of protected areas for tropical biodiversity. Nature 620, 807–812 (2023). [https://doi.org/10.1038/s41586-023-06410-z](https://doi.org/10.1038/s41586-023-06410-z)

Using a causal framework that controls for forest structure, site accessibility, and geographic location through matching, Brodie et al. (2023) find evidence that protected areas (PA) preserve vertebrate biodiversity within their boundaries and in the adjacent unprotected landscape. 

In this reproduction, we attempt to identically reproduce the primary results of the original study. 
The results of interest include 1) six measures of the effect of PA status on bird and mammal biodiversity, 2) six measures of the effect of adjacency to a large PA on bird and mammal biodiversity at unprotected sites, and 3) six measures of the effect of distance from a PA on bird and mammal biodiversity at unprotected sites.
We attempt the reproduction twice. 
First, we use the data and code published with author correction in April 2024. 
Second, for completeness and because we had already begun our reproduction attempt before the correction was published, we attempt the reproduction using the code and data shared with the original publication in August 2023. 
A successful reproduction should recreate the numerical results published in Brodie et al. (2023), or the those published with the correction in April 2024. 

All materials and procedures used in this reproduction are publicly available at GitHub **(LINK)** with the identifier **PROJECT DOI**.
We implemented the reproduction in MacBook Pros using R programming language (Version 4.2.2).
Structural causal modeling was performed using the DAGITTY package (Version #.#.#).
We used the MatchIt package (Version #.#.#) to perform propensity score matching and the NLME package (Version #.#.#) to fit the linear mixed effects regression models.


# Study design
We attempt to reproduce the statistical results of the original authors by implementing their workflow as identically as possible. 
This effort allows us to assess study design and conclusion validity of the original study. 
The spatial extent of this reproduction attempt is Southeast Asia, matching the area studied by the original authors. 
The spatial scale of our statistical analysis is the observation site level with national scale adjustments for human development levels.
Our primary data source is the data files publicly shared by Brodie et al. (2023). 
All data acquisition from original sources followed the procedures presented by the authors. 
Both the original study and our reproduction attempt were conducted in R. 


## Original Study Design
The original study uses a quasi-experimental design with the objective of identifying the causal effect of PAs on tropical biodiversity in Southeast Asia while deconfounding for the influence of site accessibility and habitat quality.
The authors use three measures of bird and mammal biodiveristy as their response variables - Species richness (SR), Functional richness (FR), and Phylogenetic diversity (PD).
These response variables were derived from 1,079 sampling locations in the eBird database and 1,365 camera stations deployed across the region. 
The primary predictors of interest were 1) a binary measure indicating whether a observation site was located inside or outside a PA, 2) a binary indicator that identified of the PA closest to an unprotected site as larger than 500 sq km, and 3) a binary indicator that identified if the PA closest to an unprotected site was within 2km. 
Predictor variables measuring PA status, site accessibility, forest structure, understory density, and human development pressure were derived from the World Database of Protected Areas, the NASA Global Ecosystem Dynamics Investigation (GEDI) mission, and the UN Development program Human Development Index.
Site accessibility was proxied using circuit theory-based measures of proximity to human development^["circuit theoretical models parameterized with human travel speeds across different terrains and the locations of populations centers and transportation networks" (Brodie et al. 2023)]. 
Habitat quality was measured as the three-dimensional forest structure derived from GEDI mission.

Using propensity score matching to control for the confounds of location, site accessibility, and forest structure, Brodie et al. fit a linear mixed-effects models to estimate three PA related effects. 
First, the authors estimated the the effect of a site being located inside or outside a PA on bird and mammal biodiversity. 
In total, the authors fit six separate regression models - two response types (birds, mammals) by three biodiversity measures (SR, FR, PD) - testing the null hypothesis that:

> OR-Ho-1: The protected area status of a site has no effect on the level of mammalian of avian biodiversity observed at that site when adjusting for the confounds of site accessibility, habitat condition, and the socioeconomic development.

Brodie et al. find evidence that the legal designation of PAs provides substantial and significant benefits to Southeast Asian bird biodiversity.
The authors did not find the same effect for mammals. 
None of the three measures of mammalian biodiversity was significantly different inside v. outside or PAs.

As a complementary analysis, Brodie et al. also tested whether the biodiversity preserving effects of PAs have positive (spillover) or negative (leakage) effects on the biodiversity of unprotected areas surrounding PAs. 
Within the subset of observation sites outside PA, the authors tested for these effects using the same propensity score matching procedure and statistical framework presented above, but replaced the binary PA status predictor with the size of the nearest PA or the distance to the nearest PA in separate models.
The authors fit 12 separate regression models - two response types (birds, mammals), by three biodiversity measures (SR, FR, PD), by two PA measures (area, distance). 
The null hypothesis tested was:

> OR-Ho-2a: The total area of the protected area located closest to an unprotected observation site has no effect on the level of mammalian of avian biodiversity observed at that site when adjusting for the confounds of site accessibility, habitat condition, and the socioeconomic development.

> OR-Ho-2b: The distance to the protected area located closest to an unprotected observation site has no effect on the level of mammalian of avian biodiversity observed at that site when adjusting for the confounds of site accessibility, habitat condition, and the socioeconomic development.

Brodie et al find evidence that large PAs are associated with higher biodiversities for mammals and birds in surrounding unprotected areas, that the effects for birds are smaller than those for mammals.
The authors found that distance to the nearest PA was significantly associated with only mammal FR.


# Study metadata

## Brodie et al. (2023) Study Metadata

- `Key words`: Biodiversity, Conservation, Protected Areas, Connectivity, 30x30
- `Subject`: Ecology and Evolutionary Biology, Natural Resources and Conservation, 
- `Date created`: August 23, 2023
- `Date modified`: August 23, 2023
- `Spatial Coverage`: Southeast Asia
- `Spatial Resolution`: Species observations - GPS located point data, GEDI - derived forest structural covariates - 1 km raster, HDI - country-level, Protected Areas - PA Polygons 
- `Spatial Reference System`: WGS84, UTM
- `Temporal Coverage`: 01-2015 to 08-2021
- `Temporal Resolution`: Varies with data set


## Brodie et al. (2023) Dataset Metadata
We use the dataset provided by Brodie et al. (2023) at [https://doi.org/10.6084/m9.figshare.22527298.v1](https://doi.org/10.6084/m9.figshare.22527298.v1) to replicate and extend the work of the original authors.
However, the publicly available dataset is missing the country-level measure of the Human Development Index used in biodiversity modeling.
We gather this data from the United Nations Development program and merge it with the authors' original dataset.
To construct our site and PA connectivity measures, we independently gathered data on PA geographies from the the World Database on Protected Areas [https://www.protectedplanet.net/en/thematic-areas/wdpa?tab=WDPA](https://www.protectedplanet.net/en/thematic-areas/wdpa?tab=WDPA).
Metadata on the datasets used by the original authors and our own additions are presented below.

### eBird

The original authors gathered bird observations from eBird.

- `Title`: eBird.
- `Abstract`: A community science platform for reporting bird sightings.
- `Spatial Coverage`: Tropical region (overlapping countries of Brunei, Cambodie, China, Indonesia, Laos, Malaysia, Singapore, Thailand, and Vietnam).
- `Spatial Resolution`: Vector data model with point observations of species occurrence
- `Spatial Reference System`: Not specified.
- `Temporal Coverage`: 2015/01 - 2021/08.
- `Temporal Resolution`: Not applicable.
- `Lineage`: Brodie et al. (2023) queried and subset data directly from eBird website or its R package or API.
- `Distribution`: [eBird webpage](https://ebird.org/home) and [other download methods](https://science.ebird.org/en/use-ebird-data/download-ebird-data-products).
- `Constraints`: Non-commercial use.
- `Data Quality`: Although a direct data quality layer is not associated, Brodie et al. (2023) followed recommendations from existing studies to filter out data points.

### The World Database on Protected Areas

The original study used protected area boundaries to derive the three treatment variables (Table 3). 
Brodie et al. (2023) did not specify a data processing procedure or provide code from the preparation of protected area boundaries. 

- `Title`: The World Database on Protected Areas (WDPA).
- `Abstract`: A global database on protected areas (PAs) and other effective conservation measures (OECM).
- `Spatial Coverage`: Tropical region (overlapping countries of Brunei, Cambodia, China, Indonesia, Laos, Malaysia, Singapore, Thailand, and Vietnam).
- `Spatial Resolution`: Vector.
- `Spatial Reference System`: WGS 84.
- `Temporal Coverage`: Accessed sometime in 2023
- `Temporal Resolution`: Updated monthly.
- `Lineage`: Brodie et al. (2023) subset from the dataset, but procedures are unknown.
- `Distribution`: [WDPA webpage](https://www.protectedplanet.net/en/thematic-areas/wdpa?tab=WDPA).
- `Constraints`: Non-commercial use.
- `Data Quality`: Unknown.

### GEDI L2 metrics

The Global Ecosystem Dynamics Investigation (GEDI) is a spaceborne light detection and ranging (LiDAR) mission monitoring forest structure on earth. 
The original study derived both ground elevation and forest structure metrics from the Level 2 dataset of GEDI. 
Level 2 GEDI data are at footprint level so Brodie et al. (2023) used kriging interpolation to create wall-to-wall layers at 1-km resolution.

L2A includes elevation data. 
Brodie et al. computed slope and topographic position index (TPI) to represent topographic traits at each site. 
The authors used five L2B metrics, which were canopy height (relative height at 95%), plant area volume density (PAVD) between 0 and 5 m (represents understory density), cumulative plant area index from ground to canopy top, foliage height diversity of plant area index, and proportional cover. 
The authors found the five forest structure metrics to be highly correlated and only kept canopy height and understory density in models. 

- `Title`: The Global Ecosystem Dynamics Investigation Level 2 Elevation and Height Metrics.
- `Abstract`: Global footprint level observations from GEDI on ground elevation and forest structure.
- `Spatial Coverage`: Tropical region (overlapping countries of Brunei, Cambodie, China, Indonesia, Laos, Malaysia, Singapore, Thailand, and Vietnam).
- `Spatial Resolution`: Footprints are of 25-m resolution and extrapolated into 1-km resolution. 
- `Spatial Reference System`: WGS 84.
- `Temporal Coverage`: 2019/04/17 to 2022/04/12
- `Temporal Resolution`: Not applicable.
- `Lineage`: Brodie et al. (2023) queried and subset data directly from eBird website or its R package or API.
- `Distribution`: Original GEDI L2 metrics can be derived from [NASA website](https://cmr.earthdata.nasa.gov/search/concepts/C1908348134-LPDAAC_ECS.html) and Brodie et al. (2023) shared krigged results on a [ webpage](https://rcdata.nau.edu/geode_data/SEA_vertebrate_diversity_rasters).
- `Constraints`: Non-commercial use.
- `Data Quality`: Original GEDI L2 metrics have quality and degrade flags and Brodie et al. (2023) kept only data points of satisfying quality.

### Human Development Index (HDI)

Human Development Index for each country was included in the causal models to measure socioeconomic development.
Data on this measure are missing from the dataset publicly shared by Brodie et al.

- `Title`: Human Development Index
- `Abstract`: An index on the level of human development by country.
- `Spatial Coverage`: Tropical region (overlapping countries of Brunei, Cambodie, China, Indonesia, Laos, Malaysia, Singapore, Thailand, and Vietnam).
- `Spatial Resolution`: Not applicable.
- `Spatial Reference System`: Not applicable.
- `Temporal Coverage`: 2020.
- `Temporal Resolution`: Not applicable.
- `Lineage`: Direct query though the official website.
- `Distribution`: Acquired directly through [Human Development Report 2020](https://hdr.undp.org/sites/default/files/2021-22_HDR/HDR21-22_Statistical_Annex_HDI_Table.xlsx).
- `Constraints`: Non-commercial use.
- `Data Quality`: Unknown.


*Table 1* Secondary variables created from data sources.

| **Label** | **Alias** | **Definition** | **Type** | **Accuracy** | **Domain** | **Missing Data Value(s)** | **Missing Data Frequency** |
| :--: | :--: | :--: | :--: | :--: | :--: | :--: | :--: |
| **eBird** |
| SR.mean | Species richness | Number of species | Float | Unknown | Equal or greater than 0 | Not applicable | Unknown |
| maxFRic | Functional richness | Diversity of species functional traits | Float | Unknown | Equal or greater than 0 | Not applicable | Unknown |
| asymptPD | Phylogenetic diversity | Cumulative evolutionary time of the species assemblage| Float | Unknown | Equal or greater than 0 | Not applicable | Unknown |
| **WDPA** |
| PA | Within or outside PAs | Whether the point is inside a PA or not | Binary | Not applicable | 1 for inside and 0 for outside | Not applicable | Unknown |
| PA_size_km2 | Functional richness | Diversity of species functional traits | Float | Unknown | Equal or greater than 0 | Not applicable | Unknown |
| dist_to_PA | Phylogenetic diversity | Cumulative evolutionary time of the species assemblage| Float | Unknown | Equal or greater than 0 | Not applicable | Unknown |
| **GEDI L2 Metrics** |
| elev | Elevation | Ground elevation at the site (krigged) | Integer | Unknown | Equal to or greater than 0 (terrestrial observations) | Unknown | Unknown |
| slope | Slope | Slope of topography | Float | Unknown | 0 to 90 | Unknown | Unknown |
| TPI | Topographic Position Index | Difference between the elevation of a focal raster cell with those of its neighbors (not mentioned in paper) | Float | Unknwon | Not bounded | Unknown | Unknown |
| rh_95_a0.pred | Relative height at 95% | Roughly the top canopy height (krigged) | Float | Unknown | Equal to or greater than 0 | Unknown | Unknown |
| pavd_0_5.pred | Plant area volume density from 0 to 5 m | A proxy of understory forest density (krigged) | Float | Unknown | Equal to or greater than 0 | Unknown | Unknown |
| pai_a0.pred | Plant area index | Cumulative PAI from ground to canopy (krigged) | Float | Unknown | Equal to or greater than 0 | Unknown | Unknown |
| fhd_pai_1m_a0.pred | Foliage height diversity | Shannon's diversity of PAI across heights (krigged) | Float | Unknown | Equal to or greater than 0 | Unknown | Unknown |
| cover_a0.pred | Proportional coverage | Openness or closeness of canopy (krigged) | Float | Unknown | 0 to 1 | Unknown | Unknown |
| **HDI** |
| HDI | Human Development Index | Level of human development | Float | Unknown | 0 to 1 | Not applicable | Not applicable |

Note: HDI was not included in the data file shared by the orignal study. We gathered HDI values for each country from the Human Development Report 2020.





# Materials and procedure


## Computational environment

Brodie et al. (2023) cleaned up the variables and performed propensity score matching and causal analysis in R. They did not provide scripts on how they derived the biodiversity metrics, circuit theory-based metrics, HDI, and the GEDI metrics. We built upon and annotated R scripts shared by them, and added missing information on HDI to the scripts.

Required packages are as follows:

```{r package setup, echo=T, results='hide', message=FALSE}
# library(groundhog)
pkgs <- c("tidyverse", "cowplot", "here", "dagitty", "ggdag", "Hmisc", 
          "MatchIt", "modelsummary", "optmatch", "nlme")
# groundhog.library(pkgs, "2024-02-11")
lapply(pkgs, require, character.only=TRUE)
```
## Data and variables

In the original study, outcome variables for the causal models are biodiversity metrics (i.e., species richness, functional richness, and phylogenetic diversity) derived from species observations. Mammal observations were assembled by the authors from camera traps in 65 study areas in the study region. Bird observations were gathered from eBird from 2015/01 to 2021/08 following a set of filtering procedures.

The treatment variable for OR-H1 was derived from the World Database on Protected Areas (WDPA) by UNEP-WCMC, which is a binary variable on whether the sampling point is within protected areas or not.

Observations were matched based on propoensity scores of their geographic locations (i.e., latitudes and longitudes), forest canopy height, accessibility, and HDI. Predictors in the mixed-effects linear regression models were forest canopy height, site accessibility, HDI, and treatment variables.

We gathered data shared by Brodie et al. (2023). Tabular data of most model inputs were provided in a  [figshare](https://doi.org/10.6084/m9.figshare.22527298.v1). Raster files at 1-km resolution for GEDI derived metrics and circuit-based accessibility were shared through a  [weblink](https://rcdata.nau.edu/geode_data/SEA_vertebrate_diversity_rasters). Variable sources are presented in Table 1.

*Table 1*. Variables used in Brodie et al. (2023)

| **Name** | **Source** | **Usage** |
| :--: | :--: | :--: |
| Biodiversity metrics - mammals| Authors | Outcome variable |
| Biodiversity metrics - birds | eBird | Outcome variable |
| Protected area boundaries | WDPA | Treatment variables (whether inside PAs) |
| Ground elevation | NASA GEDI L2B | Predictor - elevation and topography |
| Circuit-based site accessibility (log transformed) | Authors | Predictor - site accessibility |
| Human Development Index | Human Development Report 2020 | Predictor - site accessibility |
| Forest structure metrics | NASA GEDI L2A | Predictor - forest structure |


## Prior observations  

At the beginning of this analysis, we had observed the dataset provided by Brodie et al with their publication. We noticed the following caveats in the script and raw data shared by the original study.
1) HDI was missing.
2) The process of computing biodiversity metrics, GEDI metrics, and the circuit-based accessibility metric was unclear.
3) The procedure for preprocessing and cleaning PA boundaries was unclear.

We did not manipulate the data before beginning our reproduction attempt. 

## Bias and threats to validity

Given the research design as described in the original paper and primary data shared, we find that potential spatial autocorrelation of sample points were not addressed. In addition, uncertainty issues were not discussed thoroughly in the paper, which includes 1) the representativeness of biodiversity measures, 2) the validity of forest structure measures created through krigging, and 3) accessibility represented by country-level Human Development Index.

// should we add a map/moran's I result here?
// other concerns to add?

## Data transformations

We performed a series of data pre-processing steps before building the causal models, which include 1) re-construcitng the causla diagram, and 2) cleaning up data files produced by Brodie et al. (2023).


### Conceptualization and causal diagram

Before testing the hypotheses, we re-constructed the causal diagram for OR-H1.

```{r scm, echo=T} 
# Load libraries
# library(groundhog)
pkgs <- c("dagitty", "ggdag")
# groundhog.library(pkgs, "2023-12-05")
lapply(pkgs, require, character.only=TRUE)

# ------------------------------------------------------------------------------
# Structural Causal Modelling  
# ------------------------------------------------------------------------------

# Create the directed acyclic graph (DAG) of potential causal 
# Assign PA as the exposure and diversity as the outcome.
dagBrodie <- dagitty("dag {
  PA -> Diversity
  ForestStructure -> PA
  SiteAccessibility -> PA
  Bioclimate -> ForestStructure -> PA -> Diversity
  Bioclimate -> UnderstoryDensity -> Diversity
  Bioclimate -> Diversity
  Elevation -> Bioclimate
  Elevation -> ForestStructure
  Elevation -> UnderstoryDensity
  Elevation -> SiteAccessibility
  Topography -> UnderstoryDensity
  Topography -> ForestStructure
  Topography -> SiteAccessibility
  Topography -> Diversity
  HDI -> Diversity
  PA [exposure]
  Diversity [outcome]
               }"
)

# Organize the data into a visual hierarchy
coordinates( dagBrodie ) <-  list(x = c(Diversity = 3, 
                                        UnderstoryDensity = 1, 
                                        ForestStructure = 2, 
                                        PA = 3, 
                                        SiteAccessibility = 4, 
                                        HDI = 5, 
                                        Bioclimate = 2, 
                                        Elevation = 3, 
                                        Topography = 4
                                        ),
                                  y = c(Diversity = 3, 
                                        UnderstoryDensity = 2, 
                                        ForestStructure = 2, 
                                        PA = 2, 
                                        SiteAccessibility = 2, 
                                        HDI = 2, 
                                        Bioclimate = 1, 
                                        Elevation = 1, 
                                        Topography = 1
                                        ))

# Plot the DAG to confirm the visual structure and exposure
ggdag_status(dagBrodie) + theme_dag()

# Identify the set of adjustment variables needed to identify 
# the effect of PA on biodiversity 
adjustmentSets(dagBrodie)

```

### Original study

#### Data preparation for bird models


```{r OR_bird_prep, echo=T, message=FALSE}
# rm(list = ls())

# Load the data provided by Brodie et al. (2023)
dat_brodie_bird <- data.frame(read.csv(
                          here("data/raw/public/training/bird_data_230326.csv"), 
                          header = T))

# Simplify the variable names of site identifier and geographic coordinates
names(dat_brodie_bird)[names(dat_brodie_bird) == "site"] <- "station"
names(dat_brodie_bird)[names(dat_brodie_bird) == "lat_wgs84"] <- "lat"
names(dat_brodie_bird)[names(dat_brodie_bird) == "long_wgs84"] <- "long"


# Search for HDI in the column names 
grep("hdi", names(dat_brodie_bird), value = TRUE)
grep("HDI", names(dat_brodie_bird), value = TRUE)

# Assign stations the HDI value of its country
# Reference: Human Development Report 2020: The Next Frontier—Human Development 
# and the Anthropocene (United Nations Development Programme, 2020).
# https://hdr.undp.org/data-center/human-development-index#/indicies/HDI
# https://hdr.undp.org/sites/default/files/2021-22_HDR/HDR21-22_Statistical_Annex_HDI_Table.xlsx

dat_HDI <- data.frame(
    country = unique(dat_brodie_bird$country), 
    HDI = c(0.593, 0.768, 0.705, 0.607, 0.803, 0.939, 0.800, 
            0.703, 0.829))
dat_brodie_bird <- left_join(dat_brodie_bird, dat_HDI, by = "country")

# Create dataframe containing the subset of variable used in the analysis
dat_bird <- dat_brodie_bird %>% select(station, country, PA, utm_east, utm_north, 
                             Hansen_recentloss,access_log10, HDI, dist_to_PA, 
                             PA_size_km2, rh_95_a0.pred, pavd_0_5.pred, 
                             pai_a0.pred, fhd_pai_1m_a0.pred, cover_a0.pred, 
                             agbd_a0.pred,asymptPD, maxFRic, SR.mean)


# Scale subset of continuous variables in dat
# Peter - Need to add the connectivity measures to the scaling list when they 
# are introduced
dat_scale_bird <- data.frame(scale(subset(dat_bird, select = c("utm_east", "utm_north", 
                                                     "HDI", "access_log10", 
                                                     "PA_size_km2", 
                                                     "dist_to_PA", 
                                                     "rh_95_a0.pred", 
                                                     "pavd_0_5.pred", 
                                                     "pai_a0.pred", 
                                                     "fhd_pai_1m_a0.pred", 
                                                     "cover_a0.pred", 
                                                     "agbd_a0.pred"), 
                                     ), 
                              center = TRUE, scale = TRUE))

# Append scaled variables to data with .z suffixes
dat_bird[paste0(names(dat_scale_bird), '.z')] <- dat_scale_bird

# Rename scaled, predicted relative canopy height at 95% (rh_95_a0.pred.z) 
# as forest_structure to match DAG 
names(dat_bird)[names(dat_bird) == "rh_95_a0.pred.z"] <- "forest_structure"

# Rename scaled, predicted plant area volume density between 0m and 5m 
# (pavd_0_5.pred.z) as understory_density to match DAG
names(dat_bird)[names(dat_bird) == "pavd_0_5.pred.z"] <- "understory_density"

# Exclude stations that underwent recent forest loss as defined by 
# Hansen et al. (2013)
dat_clean_bird <- subset(dat_bird, Hansen_recentloss == 0)
```




### Updated study
#### Data preparation for bird models

We performed a series of data preparation procedures based on scripts nad raw data shared by Brodie et al. (2023) for birds and mammals separately. Steps included 1) adding country-specific HDI values which were missing from the raw data, 2) standardizing variables, and 3) following the original script to discard different outliers for different models.

```{r bird_prep, echo=T, message=FALSE}
# rm(list = ls())

# Load the data provided by Brodie et al. (2023)
dat_brodie_bird <- data.frame(read.csv(
                          here("data/raw/public/training/bird_data_230326.csv"), 
                          header = T))

# Simplify the variable names of site identifier and geographic coordinates
names(dat_brodie_bird)[names(dat_brodie_bird) == "site"] <- "station"
names(dat_brodie_bird)[names(dat_brodie_bird) == "lat_wgs84"] <- "lat"
names(dat_brodie_bird)[names(dat_brodie_bird) == "long_wgs84"] <- "long"

# Search for HDI in the column names 
grep("hdi", names(dat_brodie_bird), value = TRUE)
grep("HDI", names(dat_brodie_bird), value = TRUE)

# Assign stations the HDI value of its country
# Reference: Human Development Report 2020: The Next Frontier—Human Development 
# and the Anthropocene (United Nations Development Programme, 2020).
# https://hdr.undp.org/data-center/human-development-index#/indicies/HDI
# https://hdr.undp.org/sites/default/files/2021-22_HDR/HDR21-22_Statistical_Annex_HDI_Table.xlsx

dat_HDI <- data.frame(
    country = unique(dat_brodie_bird$country), 
    HDI = c(0.593, 0.768, 0.705, 0.607, 0.803, 0.939, 0.800, 
            0.703, 0.829))
dat_brodie_bird <- left_join(dat_brodie_bird, dat_HDI, by = "country")

# Create dataframe containing the subset of variable used in the analysis
dat_bird <- dat_brodie_bird %>% select(station, country, PA, utm_east, utm_north, 
                             Hansen_recentloss,access_log10, HDI, dist_to_PA, 
                             PA_size_km2, rh_95_a0.pred, pavd_0_5.pred, 
                             pai_a0.pred, fhd_pai_1m_a0.pred, cover_a0.pred, 
                             agbd_a0.pred,asymptPD, maxFRic, SR.mean)


# Scale subset of continuous variables in data frame
dat_scale_bird <- data.frame(scale(subset(dat_bird, select = c("utm_east", "utm_north", 
                                                     "HDI", "access_log10", 
                                                     "PA_size_km2", 
                                                     "dist_to_PA", 
                                                     "rh_95_a0.pred", 
                                                     "pavd_0_5.pred", 
                                                     "pai_a0.pred", 
                                                     "fhd_pai_1m_a0.pred", 
                                                     "cover_a0.pred", 
                                                     "agbd_a0.pred"), 
                                     ), 
                              center = TRUE, scale = TRUE))

# Append scaled variables to data with .z suffixes
dat_bird[paste0(names(dat_scale_bird), '.z')] <- dat_scale_bird

# Rename scaled, predicted relative canopy height at 95% (rh_95_a0.pred.z) 
# as forest_structure to match DAG 
names(dat_bird)[names(dat_bird) == "rh_95_a0.pred.z"] <- "forest_structure"

# Rename scaled, predicted plant area volume density between 0m and 5m 
# (pavd_0_5.pred.z) as understory_density to match DAG
names(dat_bird)[names(dat_bird) == "pavd_0_5.pred.z"] <- "understory_density"

# Exclude stations that underwent recent forest loss as defined by 
# Hansen et al. (2013)
dat_clean_bird <- subset(dat_bird, Hansen_recentloss == 0)
```

### Data preparation for mammal models

We performed the same steps for mammals.

```{r mammal_prep, echo=T, message=FALSE}
# Load the data provided by Brodie et al. (2023)
dat_brodie_mam <- data.frame(read.csv(
    here("data/raw/public/training/mammal_data_230326.csv"), header = T))

# Simplify the variable names of site identifier and geographic coordinates
names(dat_brodie_mam)[names(dat_brodie_mam) == "site"] <- "station"
names(dat_brodie_mam)[names(dat_brodie_mam) == "lat_wgs84"] <- "lat"
names(dat_brodie_mam)[names(dat_brodie_mam) == "long_wgs84"] <- "long"

# Search for HDI in the column names 
grep("hdi", names(dat_brodie_mam), value = TRUE)
grep("HDI", names(dat_brodie_mam), value = TRUE)

# Assign stations the HDI value of its country
# Reference:
# Human Development Report 2020: The Next Frontier—Human Development and the 
# Anthropocene (United Nations Development Programme, 2020).
# website: https://hdr.undp.org/data-center/human-development-index#/indicies/HDI
# https://hdr.undp.org/sites/default/files/2021-22_HDR/HDR21-22_Statistical_Annex_HDI_Table.xlsx
dat_HDI <- data.frame(
    country = unique(dat_brodie_mam$country), 
    HDI = c(0.803, 0.768, 0.800, 0.705, 0.939,  0.703))
dat_brodie_mam <- left_join(dat_brodie_mam, dat_HDI, by = "country")

# Create dataframe containing the subset of variable used in the analysis
dat_mam <- dat_brodie_mam %>% select(station, study_area, country, PA, utm_east, utm_north, 
                             Hansen_recentloss,access_log10, HDI, dist_to_PA, 
                             PA_size_km2, rh_95_a0.pred, pavd_0_5.pred, 
                             pai_a0.pred, fhd_pai_1m_a0.pred, cover_a0.pred, 
                             agbd_a0.pred,asymptPD, maxFRic, SR.mean)


# Scale subset of continuous variables in data frame
dat_scale_mam <- data.frame(scale(subset(dat_mam, select = c("utm_east", "utm_north", 
                                                     "HDI", "access_log10", 
                                                     "PA_size_km2", 
                                                     "dist_to_PA", 
                                                     "rh_95_a0.pred", 
                                                     "pavd_0_5.pred", 
                                                     "pai_a0.pred", 
                                                     "fhd_pai_1m_a0.pred", 
                                                     "cover_a0.pred", 
                                                     "agbd_a0.pred",
                                                     "awf_rst_ptp2"), 
), 
center = TRUE, scale = TRUE))

# Append scaled variables to data with .z suffixes
dat_mam[paste0(names(dat_scale_mam), '.z')] <- dat_scale_mam

# Rename scaled, predicted relative canopy height at 95% (rh_95_a0.pred.z) 
# as forest_structure to match DAG 
names(dat_mam)[names(dat_mam) == "rh_95_a0.pred.z"] <- "forest_structure"

# Rename scaled, predicted plant area volume density between 0m and 5m 
# (pavd_0_5.pred.z) as understory_density to match DAG
names(dat_mam)[names(dat_mam) == "pavd_0_5.pred.z"] <- "understory_density"

# Exclude stations that underwent recent forest loss as defined by 
# Hansen et al. (2013)
dat_clean_mam <- subset(dat_mam, Hansen_recentloss == 0)

```


## Analysis

After data preparation, we built separate linear mixed effects models for birds and mammals using species richness, functional richness, and phylogenetic diversity values. We showed significance of variables using p-values and set thresholds of 0.001 ( *** ), 0.01 ( ** ), and 0.05 ( * ).

### Bird models

Then we run the PD, FR, and SR models for birds.

```{r bird_models, echo=T}
# ----------------- Analysis of phylogenetic diversity (PD) --------------------
# dat_PD_efficacy_bird <- subset(dat_clean_bird, med_dist == 150)
dat_PD_efficacy_bird <- dat_clean_bird

# Remove high-leverage outliers identified by Brodie et al. 
### Brodie et al. identified outlier using the hatvalue function. We should run 
### the analysis with their outlier set removed, but also run the hatvalues 
### analysis to identify the outliers for our particular specification thereby 
### mirroring their procedure.

PD_efficacy_outliers_bird <- c("L2422371", "L3776738", "L2521761", "L6127181", 
                          "L3865754")
dat_PD_efficacy_bird <- dat_PD_efficacy_bird[! dat_PD_efficacy_bird$station %in% 
                                       PD_efficacy_outliers_bird, ]

# Select variables for analysis and restrict to rows with complete values 
# Peter - We need to add the eventual connectivity measures to this selection 
# so they are in place for our extended analysis

dat_PD_efficacy_bird <- dat_PD_efficacy_bird %>% select(asymptPD, PA, country, utm_east, 
                          utm_north, utm_east.z, utm_north.z, forest_structure, 
                          access_log10.z, HDI.z)
dat_PD_efficacy_bird <- dat_PD_efficacy_bird[complete.cases(dat_PD_efficacy_bird), ]

# Perform propensity score matching following the DAG developed in the 
# structural causal modeling  and retrieve the matched dataset
match_PD_bird <- matchit(PA ~ utm_east.z + utm_north.z + forest_structure + 
                        access_log10.z + HDI.z,	
                    data = dat_PD_efficacy_bird, method = "full", 
                    distance = "glm", link = "probit", replace = F)
dat_matched_PD_bird <- match.data(match_PD_bird)

# Run original Brodie linear mixed effects model with exponential spatial 
# correlation structure for the residuals 
mod_PD_efficacy_bird <- lme(asymptPD ~ forest_structure + access_log10.z 
                       + HDI.z + PA, random = list(~1 | country), 
                       data = dat_matched_PD_bird, weights = ~I(1/weights), 
                       correlation = corExp(form = ~utm_east + utm_north, 
                                            nugget = TRUE))
# summary(mod_PD_efficacy_bird) 


# ----------------- Analysis of Functional Richness (FR) -----------------------
dat_FR_efficacy_bird <- dat_clean_bird

# Remove high-leverage outliers identified by Brodie et al. 
### Brodie et al. identified outlier using the hatvalue function. We should run 
### the analysis with their outlier set removed, but also run the hatvalues 
### analysis to identify the outliers for our particular specification thereby 
### mirroring their procedure.

FR_efficacy_outliers_bird <- c("L921125", "L2422371", "L4331944", "L13465594")
dat_FR_efficacy_bird <- dat_FR_efficacy_bird[! dat_FR_efficacy_bird$station %in% 
                                       FR_efficacy_outliers_bird, ]

# Select variables for analysis and restrict to rows with complete values 
# Peter - We need to add the eventual connectivity measures to this selection 
# so they are in place for our extended analysis

# No variable named maxFR in the csv, only maxFRic, not fully sure if they are the same
dat_FR_efficacy_bird <- dat_FR_efficacy_bird %>% 
    select(maxFRic, PA, country, utm_east, 
           utm_north, utm_east.z, utm_north.z, forest_structure, 
           access_log10.z, HDI.z)
dat_FR_efficacy_bird <- dat_FR_efficacy_bird[complete.cases(dat_FR_efficacy_bird), ]

# Perform propensity score matching following the DAG developed in the 
# structural causal modeling  and retrieve the matched dataset
match_FR_bird <- matchit(PA ~ utm_east.z + utm_north.z + forest_structure + 
                        access_log10.z + HDI.z,	
                    data = dat_FR_efficacy_bird, method = "full", 
                    distance = "glm", link = "probit", replace = F)
dat_matched_FR_bird <- match.data(match_FR_bird)

# Run original Brodie linear mixed effects model with exponential spatial 
# correlation structure for the residuals 
mod_FR_efficacy_bird <- lme(maxFRic ~ forest_structure + access_log10.z 
                       + HDI.z + PA, random = list(~1 | country), 
                       data = dat_matched_FR_bird, weights = ~I(1/weights), 
                       correlation = corExp(form = ~utm_east + utm_north, 
                                            nugget = TRUE))
# summary(mod_FR_efficacy)

# ------------------- Analysis of species richness (SR) ------------------------

# dat_SR_efficacy_bird <- subset(dat_clean_bird, med_dist == 100) 
dat_SR_efficacy_bird <- dat_clean_bird
# Wenxin: why is the med_dist different here? should we use the same distance for all measures?  It does not really matter for the reproduction though.

# Remove high-leverage outliers identified by Brodie et al. 
### Brodie et al. identified outlier using the hatvalue function. We should run 
### the analysis with their outlier set removed, but also run the hatvalues 
### analysis to identify the outliers for our particular specification thereby 
### mirroring their procedure.

SR_efficacy_outliers_bird <- c("L4789498", "L921125", "L1122096", 
                          "L7010824", "L3865754", "L3776738")
dat_SR_efficacy_bird <- dat_SR_efficacy_bird[! dat_SR_efficacy_bird$station %in% 
                                       SR_efficacy_outliers_bird, ]

# Select variables for analysis and restrict to rows with complete values 
# Peter - We need to add the eventual connectivity measures to this selection 
# so they are in place for our extended analysis

dat_SR_efficacy_bird <- dat_SR_efficacy_bird %>% 
    select(SR.mean, PA, country, utm_east, 
           utm_north, utm_east.z, utm_north.z, forest_structure, 
           access_log10.z, HDI.z)
dat_SR_efficacy_bird <- dat_SR_efficacy_bird[complete.cases(dat_SR_efficacy_bird), ]

# Perform propensity score matching following the DAG developed in the 
# structural causal modeling  and retrieve the matched dataset
match_SR_bird <- matchit(PA ~ utm_east.z + utm_north.z + forest_structure + 
                        access_log10.z + HDI.z,	
                    data = dat_SR_efficacy_bird, method = "full", 
                    distance = "glm", link = "probit", replace = F)
dat_matched_SR_bird <- match.data(match_SR_bird)

# Run original Brodie linear mixed effects model with exponential spatial 
# correlation structure for the residuals 
mod_SR_efficacy_bird <- lme(SR.mean ~ forest_structure + access_log10.z 
                       + HDI.z + PA, random = list(~1 | country), 
                       data = dat_matched_SR_bird, weights = ~I(1/weights), 
                       correlation = corExp(form = ~utm_east + utm_north, 
                                            nugget = TRUE))

# summary(mod_SR_efficacy_bird) 

# Summarize the model outputs in a table
# msummary(list('Bird PD'=mod_PD_efficacy_bird, 'Bird FR'=mod_FR_efficacy_bird, 'Bird SR'=mod_SR_efficacy_bird), stars = TRUE)
```


### Mammal models

We run PD, FR, and SR models for mammals.

```{r mammal_models, echo=T, message=FALSE}
# ----------------- Analysis of phylogenetic diversity (PD) --------------------
dat_PD_efficacy_mam <- subset(dat_clean_mam, med_dist == 100)

# Select variables for analysis and restrict to rows with complete values 

dat_PD_efficacy_mam <- dat_PD_efficacy_mam %>% 
    select(asymptPD, PA, study_area, country, utm_east, 
           utm_north, utm_east.z, utm_north.z, forest_structure, 
           access_log10.z, HDI.z, awf_rst_ptp2.z)
dat_PD_efficacy_mam <- dat_PD_efficacy_mam[complete.cases(dat_PD_efficacy_mam), ]

# Perform propensity score matching following the DAG developed in the 
# structural causal modeling  and retrieve the matched dataset
match_PD_mam <- matchit(PA ~ utm_east.z + utm_north.z + forest_structure + 
                        access_log10.z + HDI.z,	
                    data = dat_PD_efficacy_mam, method = "full", 
                    distance = "glm", link = "probit", replace = F)
dat_matched_PD_mam <- match.data(match_PD_mam)

# Run original Brodie linear mixed effects model with exponential spatial 
# correlation structure for the residuals 
mod_PD_efficacy_mam <- lme(asymptPD ~ forest_structure + access_log10.z 
                       + HDI.z + PA, random = list(~1 | country, ~1 | study_area), 
                       data = dat_matched_PD_mam, weights = ~I(1/weights), 
                       correlation = corExp(form = ~utm_east + utm_north, 
                                            nugget = TRUE))
# summary(mod_PD_efficacy_mam)


# ----------------- Analysis of Functional Richness (FR) -----------------------

dat_FR_efficacy_mam <- subset(dat_clean_mam, med_dist == 100)

# Select variables for analysis and restrict to rows with complete values 

# No variable named maxFR in the csv, only maxFRic, not fully sure if they are the same
dat_FR_efficacy_mam <- dat_FR_efficacy_mam %>% 
    select(maxFRic, PA, study_area, country, utm_east, 
           utm_north, utm_east.z, utm_north.z, forest_structure, 
           access_log10.z, HDI.z, awf_rst_ptp2.z)
dat_FR_efficacy_mam <- dat_FR_efficacy_mam[complete.cases(dat_FR_efficacy_mam), ]

# Perform propensity score matching following the DAG developed in the 
# structural causal modeling  and retrieve the matched dataset
match_FR_mam <- matchit(PA ~ utm_east.z + utm_north.z + forest_structure + 
                        access_log10.z + HDI.z,	
                    data = dat_FR_efficacy_mam, method = "full", 
                    distance = "glm", link = "probit", replace = F)
dat_matched_FR_mam <- match.data(match_FR_mam)

# Run original Brodie linear mixed effects model with exponential spatial 
# correlation structure for the residuals 
mod_FR_efficacy_mam <- lme(maxFRic ~ forest_structure + access_log10.z 
                       + HDI.z + PA, random = list(~1 | country, ~1 | study_area), 
                       data = dat_matched_FR_mam, weights = ~I(1/weights), 
                       correlation = corExp(form = ~utm_east + utm_north, 
                                            nugget = TRUE))
# summary(mod_FR_efficacy_mam)

# ------------------- Analysis of species richness (SR) ------------------------

dat_SR_efficacy_mam <- subset(dat_clean_mam, med_dist == 100)

# Select variables for analysis and restrict to rows with complete values 

dat_SR_efficacy_mam <- dat_SR_efficacy_mam %>% 
    select(SR.mean, PA, study_area, country, utm_east, 
           utm_north, utm_east.z, utm_north.z, forest_structure, 
           access_log10.z, HDI.z, awf_rst_ptp2.z)
dat_SR_efficacy_mam <- dat_SR_efficacy_mam[complete.cases(dat_SR_efficacy_mam), ]

# Perform propensity score matching following the DAG developed in the 
# structural causal modeling  and retrieve the matched dataset
match_SR_mam <- matchit(PA ~ utm_east.z + utm_north.z + forest_structure + 
                        access_log10.z + HDI.z,	
                    data = dat_SR_efficacy_mam, method = "full", 
                    distance = "glm", link = "probit", replace = F)
dat_matched_SR_mam <- match.data(match_SR_mam)

# Run original Brodie linear mixed effects model with exponential spatial 
# correlation structure for the residuals 
mod_SR_efficacy_mam <- lme(SR.mean ~ forest_structure + access_log10.z 
                       + HDI.z + PA, random = list(~1 | country, ~1 | study_area), 
                       data = dat_matched_SR_mam, weights = ~I(1/weights), 
                       correlation = corExp(form = ~utm_east + utm_north, 
                                            nugget = TRUE))

```


# Results

```{r results, echo=T}
#summary(mod_SR_efficacy_mam) 
msummary(list('Bird SR'=mod_SR_efficacy_bird, 'Bird FR'=mod_FR_efficacy_bird, 'Bird PD'=mod_PD_efficacy_bird,'Mammal SR'=mod_SR_efficacy_mam, 'Mammal FR'=mod_FR_efficacy_mam, 'Mammal PD'=mod_PD_efficacy_mam
              ),stars = TRUE)

# Note: if rendering this part of the code returns errors for tex rendering
# Please consider going through steps on this debugging page:
# https://yihui.org/tinytex/r/#debugging
 
# Also: https://github.com/travis-ci/travis-ci/issues/10166
# sudo tlmgr install 
# could be really helpful

```

We compared reproduction results with Extended Table 1 in Brodie et al. (2023) and found general similar results. We identified significant PA effects on bird species diversity and non significant effects on mammal species diversity as reported in the paper. PA effect sizes for SR (OR:27.04, RPR:31.6), FR (OR:24.02, RPR:25.52), PD (OR:0.38, RPR:0.37) from the reproduction are similar to those reported in Brodie et al. (2023). Significance of other variables and their coefficient values were also similar to the original study.


# Discussion & Conclusion

The goal of the report is to reproduce analysis and results from Brodie et al. (2023) on the effect of protected areas to preserve tropical bird and mammal biodiversity after removing confounding effects of site accessibility and forest structure. The original paper provided scripts and data which allowed for reproductions. The scripts were in general reproducible while missing data preprocessing steps such as cleaning protected area boundaries and computing secondary variables from raw data (e.g., GEDI metrics and circuit-based accessibiltiy metrics). The data file contained most information but did not include raw observation data, a meta data file, or include HDI.

While there are ways to improve the reproducibility of the original work, our reproduction found results that were consistent with the main findings of Brodie et al. (2023). We found supporting evidence for OR-H1 (i.e., similar coefficient values and significance) as the original study but were unable to reproduce exact results as Brodie et al. (2023). Reasons for the differences could be HDI values, data version issues, or computation environment.

Through reconstructing the causal diagram and reproduction, we found that connectivity from sampling points to protected areas was not accounted for in the original study. We introduced hypothesis RPL-01 and tested it in our replication study.

# Integrity Statement

The authors of this preregistration state that they completed this preregistration to the best of their knowledge and that no other preregistration exists pertaining to the same hypotheses and research.

# Acknowledgements

- `Funding Name`: name of funding for the project
- `Funding Title`: title of project grant
- `Award info URI`: web address for award information
- `Award number`: award number

This report is based upon the template for Reproducible and Replicable Research in Human-Environment and Geographical Sciences, DOI:[10.17605/OSF.IO/W29MQ](https://doi.org/10.17605/OSF.IO/W29MQ)

# References
Brodie, J.F., Mohd-Azlan, J., Chen, C. et al. Landscape-scale benefits of protected areas for tropical biodiversity. Nature 620, 807–812 (2023). <https://doi.org/10.1038/s41586-023-06410-z>