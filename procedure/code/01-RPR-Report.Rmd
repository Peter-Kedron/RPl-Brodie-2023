---
title: "Does protected area connectivity moderate the efficacy of protection on tropical biodiversity? Evidence from a replication of Brodie et al. 2023"
author: "Peter Kedron, Lei Song, Wenxin Yang, Amy Frazier"
date: "`r Sys.Date()`"
output: 
  pdf_document:
    toc: false
    number_sections: true
editor_options:
  markdown:
    wrap: sentence
knit: (function(inputFile, encoding) {
  rmarkdown::render(inputFile, encoding = encoding, output_dir = "../../docs/manuscript") })
---
```{r chunk setup, include = FALSE, message = FALSE}
# record all the packages you are using here
# this includes any calls to library(), require(),
# and double colons such as here::i_am()
packages <- c("tidyverse", "here")

# force all conflicts to become errors
require(conflicted)
library(here)

# load and install required packages
# https://groundhogr.com/
if (!require(groundhog)) {
  install.packages("groundhog")
  require(groundhog)
}

# record the R processing environment
writeLines(
  capture.output(sessionInfo()),
  here("procedure", "environment", paste0("r-environment-", Sys.Date(), ".txt"))
)

# save package citations
knitr::write_bib(c(packages, "base"), file = here("software.bib"))

# set up default knitr parameters
# https://yihui.org/knitr/options/
knitr::opts_chunk$set(
  echo = FALSE, # Run code, show outputs (don't show code)
  fig.retina = 4,
  fig.width = 8,
  fig.path = paste0(here("results", "figures"), "/"),
  warning = FALSE,
  message = FALSE,
  include = TRUE,
  tidy.opts = list(width.cutoff = 60),
  tidy = TRUE
  # knitr::include_graphics()
)

# set working directory as the project folder
knitr::opts_knit$set(root.dir = here(''))
options(tinytex.verbose = TRUE)
```

# Introduction
This study is a *computational reproduction* of:

> Brodie, J.F., Mohd-Azlan, J., Chen, C. et al. Landscape-scale benefits of protected areas for tropical biodiversity. Nature 620, 807â€“812 (2023). [https://doi.org/10.1038/s41586-023-06410-z](https://doi.org/10.1038/s41586-023-06410-z)

Using a causal framework that controls for forest structure, site accessibility, and geographic location through matching, Brodie et al. (2023) find evidence that protected areas (PA) preserve vertebrate biodiversity within their boundaries and in the adjacent unprotected landscape. 

In this reproduction, we attempt to identically reproduce the primary results of the original study. 
The results of interest include:

1. six measures of the effect of PA status on bird and mammal biodiversity, 
2. six measures of the effect of adjacency to a large PA on bird and mammal biodiversity at unprotected sites
3. six measures of the effect of distance from a PA on bird and mammal biodiversity at unprotected sites.

We attempt the reproduction using data and code files published with an author correction in April 2024. 
A successful reproduction should recreate the numerical results published in Brodie et al. (2023), or the those published with the correction in April 2024. 

All materials and procedures used in this reproduction are publicly available at GitHub **(LINK)** with the identifier **PROJECT DOI**.
That repository also contains a series of scripts and functions to re-execute this reproduction attempt and a related replication attempt.
We implemented the reproduction in platform `r R.version$platform` using R programming language (Version `r paste0(R.version$major, ".", R.version$minor)`).
Structural causal modeling was performed using the DAGITTY package (Version `r packageVersion('dagitty')`).
We used the MatchIt package (Version `r packageVersion('matchit')`) to perform propensity score matching and the NLME package (Version `r packageVersion('nlme')`) to fit the linear mixed effects regression models.


# Study design
We attempt to reproduce the statistical results of the original authors by implementing their workflow as identically as possible. 
This effort allows us to assess study design and conclusion validity of the original study. 
The spatial extent of this reproduction attempt is Southeast Asia, matching the area studied by the original authors. 
The spatial scale of our statistical analysis is the observation site level with national scale adjustments for human development levels.
Our primary data source is the data files publicly shared by Brodie et al. (2023). 
All data acquisition from original sources followed the procedures presented by the authors. 
Both the original study and our reproduction attempt were conducted in R. 


## Original Study Design
The original study uses a quasi-experimental design with the objective of identifying the causal effect of PAs on tropical biodiversity in Southeast Asia while deconfounding for the influence of site accessibility and habitat quality.
The authors use three measures of bird and mammal biodiveristy as their response variables - Species richness (SR), Functional richness (FR), and Phylogenetic diversity (PD).
Bird observations were gathered from 1,079 sampling locations in the eBird database spanning the period between January 2015 and August 2021. 
Mammal observations were assembled by the authors from camera traps 1,365 camera stations deployed across the region. 

The primary predictors of interest were:

1. A binary measure indicating whether a observation site was located inside or outside a PA
2. a binary indicator that identified of the PA closest to an unprotected site as larger than 500 sq km
3. a binary indicator that identified if the PA closest to an unprotected site was within 2km. 

Primary predictors measuring PA status were derived from the World Database of Protected Areas.
Additional predictors used to deconfound for site accessibility, forest structure, understory density, and human development pressure were derived from the NASA Global Ecosystem Dynamics Investigation (GEDI) mission, and the UN Development program Human Development Index.
Site accessibility was measured using circuit theory-based metrics of proximity to human development^["circuit theoretical models parameterized with human travel speeds across different terrains and the locations of populations centers and transportation networks" (Brodie et al. 2023)]. 
Forest structure and understory density were measured use three-dimensional metrics derived from GEDI mission.
Code to produce these predictors was not provided by the authors. 

Using propensity score matching to control for the confounds of location, site accessibility, and forest structure, Brodie et al. fit a linear mixed-effects models to estimate three PA related effects. 
The authors completed two sets of statistical analyses.
First, the authors estimated the the effect of a site being located inside or outside a PA on bird and mammal biodiversity. 
In total, the authors fit six separate regression models - two response variable taxons (birds, mammals) for three biodiversity measures (SR, FR, PD) - testing the null hypothesis that:

> OR-Ho-1: The protected area status of a site has no effect on the level of mammalian or avian biodiversity observed at that site when adjusting for the confounds of site accessibility, habitat condition, and the socioeconomic development.

Brodie et al. find evidence that the legal designation of PAs provides substantial and significant benefits to Southeast Asian bird biodiversity.
The authors did not find the same effect for mammals. 
None of the three measures of mammalian biodiversity was significantly different inside v. outside or PAs.

Second, Brodie et al. tested whether the biodiversity preserving effects of PA status have positive (spillover) or negative (leakage) effects on the biodiversity of unprotected areas surrounding PAs. 
Within the subset of observation sites outside PA, the authors tested for these effects using the same propensity score matching procedure and statistical framework presented above, but replaced the binary PA status predictor with the size of the nearest PA or the distance to the nearest PA in separate models.
In total, the authors fit 12 separate regression models - two response variable taxons (birds, mammals), by three biodiversity measures (SR, FR, PD), by two PA measures (area, distance). 
The null hypothesis tested were:

> OR-Ho-2a: Being located within 2km of a protected area of at least 500 $km^2$ in size has no effect on the level of mammalian of avian biodiversity observed at an unprotected site when adjusting for the confounds of site accessibility, habitat condition, the socioeconomic development, and distance to that protected site.

> OR-Ho-2b: The distance to the protected area located closest to an unprotected observation site has no effect on the level of mammalian of avian biodiversity observed at that site when adjusting for the confounds of site accessibility, habitat condition, the socioeconomic development, and adjacency to a large protected area.

\par

Brodie et al find evidence that large PAs are associated with higher biodiversities for mammals and birds in surrounding unprotected areas, but that the effects for birds are smaller than those for mammals.
The authors found that distance to the nearest PA was significantly associated with only mammal functional richness.


## Study-level metadata

- `Key words`: Biodiversity, Conservation, Protected Areas, Connectivity, 30x30
- `Subject`: Ecology and Evolutionary Biology, Natural Resources and Conservation, 
- `Date created`: August 23, 2023
- `Date modified`: August 23, 2023
- `Spatial Coverage`: Southeast Asia
- `Spatial Resolution`: Species observations - GPS located point data, GEDI - derived forest structural covariates - 1 km raster, HDI - country-level, Protected Areas - PA Polygons 
- `Spatial Reference System`: WGS84, UTM
- `Temporal Coverage`: 01-2015 to 08-2021
- `Temporal Resolution`: Varies with data set


## Data-level Metadata
We use the author corrected dataset available at [https://figshare.com/authors/Jedediah_Brodie/9745991](https://figshare.com/authors/Jedediah_Brodie/9745991) to conduct our reproduction .
The authors' originally published dataset (available at [https://doi.org/10.6084/m9.figshare.22527298.v1](https://doi.org/10.6084/m9.figshare.22527298.v1)) is missing the country-level measure of the Human Development Index used in biodiversity modeling.
For completeness, we gathered and include here metadata on the datasets used by the original authors to construct their shared analytical datasets.


### eBird
Brodie et al. use the eBird database to construct the biodiversity measures for birds that are then used as response variables in statistical modeling. 
The authors did not provide scripts on how they derived the biodiversity metrics.

- `Title`: eBird.
- `Abstract`: A community science platform for reporting bird sightings.
- `Spatial Coverage`: Tropical region (overlapping countries of Brunei, Cambodia, China, Indonesia, Laos, Malaysia, Singapore, Thailand, and Vietnam).
- `Spatial Resolution`: Vector data model with point observations of species occurrence.
- `Spatial Reference System`: Not specified.
- `Temporal Coverage`: 2015/01 - 2021/08.
- `Temporal Resolution`: Not applicable.
- `Lineage`: Brodie et al. (2023) queried and subset data directly from eBird website or its R package or API.
- `Distribution`: [eBird webpage](https://ebird.org/home) and [other download methods](https://science.ebird.org/en/use-ebird-data/download-ebird-data-products).
- `Constraints`: Non-commercial use.
- `Data Quality`: Although a direct data quality layer is not associated, Brodie et al. (2023) stated that they followed recommendations from existing studies to filter out data points.

### Camera traps
Brodie et al. assembled camera trap data in the study region and pre-processed these data to construct the biodiversity measures for mammals that are then used as response variables in statistical modeling. 
The authors did not provide scripts on how they derived the biodiversity metrics.

- `Title`: Camera traps.
- `Abstract`: Data from 1,365 camera stations in 65 plots in the study region.
- `Spatial Coverage`: Southeast Asia (overlapping countries of Brunei, Cambodia, China, Indonesia, Laos, Malaysia, Singapore, Thailand, and Vietnam).
- `Spatial Resolution`: Cleaned to vector data model with point observations of species occurrence.
- `Spatial Reference System`: Not specified.
- `Temporal Coverage`: Not specified.
- `Temporal Resolution`: Not applicable.
- `Lineage`: Brodie et al. (2023) cleaned, filtered, and standardized data, and used data from the most recent year if a station contains records of more than one year.
- `Distribution`: Not applicable.
- `Constraints`: Non-commercial use.
- `Data Quality`: Unknown.


### The World Database on Protected Areas
The original study used protected area boundaries to derive the three treatment variables (Table 2). 
Brodie et al. (2023) did not specify a data processing procedure or provide code from the preparation of protected area boundaries. 

- `Title`: The World Database on Protected Areas (WDPA).
- `Abstract`: A global database on protected areas (PAs) and other effective conservation measures (OECM).
- `Spatial Coverage`: Tropical region (overlapping countries of Brunei, Cambodia, China, Indonesia, Laos, Malaysia, Singapore, Thailand, and Vietnam).
- `Spatial Resolution`: Vector.
- `Spatial Reference System`: WGS 84.
- `Temporal Coverage`: Accessed sometime in 2023
- `Temporal Resolution`: Updated monthly.
- `Lineage`: Brodie et al. (2023) subset from the dataset, but procedures are unknown.
- `Distribution`: [WDPA webpage](https://www.protectedplanet.net/en/thematic-areas/wdpa?tab=WDPA).
- `Constraints`: Non-commercial use.
- `Data Quality`: Unknown.

### GEDI L2 metrics
The Global Ecosystem Dynamics Investigation (GEDI) is a spaceborne light detection and ranging (LiDAR) mission monitoring forest structure on earth. 
The original study derived both ground elevation and forest structure metrics from the Level 2 dataset of GEDI. 
Level 2 GEDI data are at footprint level, so Brodie et al. (2023) used kriging interpolation to create wall-to-wall layers at 1-km resolution.

Level 2 GEDI data includes elevation data. 
Brodie et al. computed slope and topographic position index (TPI) to represent topographic traits at each site. 
The authors originally gathered five L2B metrics, canopy height (relative height at 95%), plant area volume density (PAVD) between 0 and 5 m (represents understory density), cumulative plant area index from ground to canopy top, foliage height diversity of plant area index, and proportional canopy cover. 
The authors found the five forest structure metrics to be highly correlated and retained only canopy height and understory density in statistical models. 

Raster files at 1-km resolution for GEDI derived metrics and circuit-based accessibility were shared through a  [weblink](https://rcdata.nau.edu/geode_data/SEA_vertebrate_diversity_rasters). 
The authors did not provide code for the calculation of GEDI metrics. 

- `Title`: The Global Ecosystem Dynamics Investigation Level 2 Elevation and Height Metrics.
- `Abstract`: Global footprint level observations from GEDI on ground elevation and forest structure.
- `Spatial Coverage`: Tropical region (overlapping countries of Brunei, Cambodie, China, Indonesia, Laos, Malaysia, Singapore, Thailand, and Vietnam).
- `Spatial Resolution`: Footprints are of 25-m resolution and extrapolated into 1-km resolution. 
- `Spatial Reference System`: WGS 84.
- `Temporal Coverage`: 2019/04/17 to 2022/04/12
- `Temporal Resolution`: Not applicable.
- `Lineage`: Brodie et al. (2023) used kriging to interpolate GEDI footprints into wall-to-wall raster data of 1-km resolution.
- `Distribution`: Original GEDI L2 metrics can be derived from [NASA website](https://cmr.earthdata.nasa.gov/search/concepts/C1908348134-LPDAAC_ECS.html) and Brodie et al. (2023) shared krigged results on a [ webpage](https://rcdata.nau.edu/geode_data/SEA_vertebrate_diversity_rasters).
- `Constraints`: Non-commercial use.
- `Data Quality`: Original GEDI L2 metrics have quality and degrade flags and Brodie et al. (2023) kept only data points of satisfying quality.

### Human Development Index (HDI)
Data on this measure are missing from the analysis file originally shared by Brodie et al..
We gathered HDI values for each country from the Human Development Report 2020 following the citation provided by the authors.
This data omission was corrected in the authors update. 
Our HDI addition to the original file matched the authors updated inclusion, other than cases where the authors noted that they hand corrected certain measures. 
Clear reasoning for those adjustments was not provided in the note on author corrections.

- `Title`: Human Development Index
- `Abstract`: An index on the level of human development by country.
- `Spatial Coverage`: Tropical region (overlapping countries of Brunei, Cambodie, China, Indonesia, Laos, Malaysia, Singapore, Thailand, and Vietnam).
- `Spatial Resolution`: Not applicable.
- `Spatial Reference System`: Not applicable.
- `Temporal Coverage`: 2020.
- `Temporal Resolution`: Not applicable.
- `Lineage`: Direct query though the official website.
- `Distribution`: Acquired directly through [Human Development Report 2020](https://hdr.undp.org/sites/default/files/2021-22_HDR/HDR21-22_Statistical_Annex_HDI_Table.xlsx).
- `Constraints`: Non-commercial use.
- `Data Quality`: Unknown.

\par

## Statistical Approach
Brodie et al. use propensity score matching to control for the potential confounding effects of site accessibility and habitat quality when estimating the efficacy of protected areas at improving bird and mammal biodiversity. 
In the PA efficacy models, observations were matched based on their geographic locations (i.e., latitudes and longitudes), forest canopy height, accessibility, and HDI. 
In spillover models, observations were matched based on these same factors and either adjacent PA size or distance to the nearest PA. 
Weights produced by propensity score matching were then used in mixed-effects linear regression models that estimated the treatment effect - PA status, nearest PA size, nearest PA distance - while adjusting for forest canopy height, site accessibility, and HDI (Table 1).


## Observations Preceeding the Reproduction Attempt  

Before beginning our reproduction attempt, we had observed the analysis file and code published by Brodie et al..
We noticed the following issues in the script and analysis file originally published by the authors.

1) The HDI measure was missing from the analysis file.
2) The procedure for computing biodiversity metrics, GEDI metrics, and the circuit-based accessibility metric was not provided in the scripts and not presented in detail in the methodological supplement.
3) The procedure for preparing PA boundaries for analysis was unclear.
4) The procedure for identifying and eliminating outliers was not included in the script. Only a hand coded list of outliers was provided and removed in the code.

The script and analysis file published by the authors with their correction in April 2024 addressed the first issue above. 
However, the other issues remain. 
We did not manipulate the corrected data file before beginning our reproduction attempt.

\par

\pagebreak

**Table 1** Response, treatment, and predictor variables generated by Brodie et al (2023).

\scriptsize
| **Label** | **Alias** | **Definition** | **Type** | **Accuracy** | **Domain** | **Missing Data Value(s)** | **Missing Data Frequency** |
| :--: | :--: | :--: | :--: | :--: | :--: | :--: | :--: |
| **eBird & camera traps** |
| SR.mean | Species richness | Number of species | Float | Unknown | Equal or greater than 0 | Not applicable | Unknown |
| maxFRic | Functional richness | Diversity of species functional traits | Float | Unknown | Equal or greater than 0 | Not applicable | Unknown |
| asymptPD | Phylogenetic diversity | Cumulative evolutionary time of the species assemblage| Float | Unknown | Equal or greater than 0 | Not applicable | Unknown |
| **WDPA** |
| PA | Within or outside PAs | Whether the point is inside a PA or not | Binary | Not applicable | 1 for inside and 0 for outside | Not applicable | Unknown |
| PA_size_km2 | PA size | The area of nearest PA in sq km | Float | Unknown | Equal or greater than 0 | Not applicable | Unknown |
| dist_to_PA | Distance to PA | The distance to the nearest PA in km | Float | Unknown | Equal or greater than 0 | Not applicable | Unknown |
| **GEDI L2 Metrics** |
| elev | Elevation | Ground elevation at the site (krigged) | Integer | Unknown | Equal to or greater than 0 (terrestrial observations) | Unknown | Unknown |
| slope | Slope | Slope of topography | Float | Unknown | 0 to 90 | Unknown | Unknown |
| TPI | Topographic Position Index | Difference between the elevation of a focal raster cell with those of its neighbors (not mentioned in paper) | Float | Unknwon | Not bounded | Unknown | Unknown |
| rh_95_a0.pred | Relative height at 95% | Roughly the top canopy height (krigged) | Float | Unknown | Equal to or greater than 0 | Unknown | Unknown |
| pavd_0_5.pred | Plant area volume density from 0 to 5 m | A proxy of understory forest density (krigged) | Float | Unknown | Equal to or greater than 0 | Unknown | Unknown |
| pai_a0.pred | Plant area index | Cumulative PAI from ground to canopy (krigged) | Float | Unknown | Equal to or greater than 0 | Unknown | Unknown |
| fhd_pai_1m_a0. pred | Foliage height diversity | Shannon's diversity of PAI across heights (krigged) | Float | Unknown | Equal to or greater than 0 | Unknown | Unknown |
| cover_a0.pred | Proportional coverage | Openness or closeness of canopy (krigged) | Float | Unknown | 0 to 1 | Unknown | Unknown |
| **HDI** |
| HDI | Human Development Index | Level of human development | Float | Unknown | 0 to 1 | Not applicable | Not applicable | 
\normalsize
Note: HDI was not included in the data file shared by the original study. We gathered HDI values for each country from the Human Development Report 2020.

**Table 2**. Variables used in statistical modeling

| **Name** | **Source** | **Usage** |
| :--: | :--: | :--: |
| Biodiversity metrics - mammals| Authors | Outcome variable |
| Biodiversity metrics - birds | eBird | Outcome variable |
| Protected area boundaries | WDPA | Treatment variables (whether inside PAs) |
| Ground elevation | NASA GEDI L2B | Predictor - elevation and topography |
| Circuit-based site accessibility (log transformed) | Authors | Predictor - site accessibility |
| Human Development Index | Human Development Report 2020 | Predictor - Human development index |
| Forest structure metrics | NASA GEDI L2A | Predictor - forest structure |


# Reproduction Attempts

We were able to statistically reproduce the results of Brodie et al. using unaltered version of the their corrected data and code files.
In an attempt to remain consisted with the original authors, we use the most recent package versions at the time of the author corrected analysis - April 26, 2024.
No additional preparation was needed for our reproduction using these materials.

For brevity and legibility, this rendered report suppresses the code used to prepare and re-execute the analysis.
However, that code is recorded and accessible in the RNotebook file that forms the basis of this report. 
That file and all related research materials are available in this projects online repository. 

```{r package setup, echo = TRUE, message = FALSE, warning = FALSE, results = 'hide'}
# , results = 'hide', message = FALSE, warning = FALSE, eval = FALSE
# Load required packages and scripts
# We made minimum changes to the original script
library(groundhog)
pkgs <- c("tidyverse", "Hmisc", "MatchIt",  "optmatch", "lme4",  "nlme", 
          "lmerTest", "cowplot",   
           "here", "modelsummary", "dagitty", "ggdag", "kableExtra",
          "MuMIn", "tibble", "broom.mixed" )
# We follow the recommendation to set the time for groundhog two weeks before 
# when the original script was edited
# groundhog.library(pkgs, "2024-03-03") 

lapply(pkgs, library, character.only=TRUE) # use this line if groundhog returns error
here('')
```

For completeness, we first reproduced the causal diagram underlying the original analysis and used the diagram to identify the predictors necessary for estimation of the causal effect of the PA treatment.

```{r SCM, echo = FALSE, out.width = '80%'} 
# Create the directed acyclic graph (DAG) of potential causal 
# Assign PA as the exposure and diversity as the outcome.
dagBrodie <- dagitty("dag {
  PA -> Diversity
  ForestStructure -> PA
  SiteAccessibility -> PA
  Bioclimate -> ForestStructure -> PA -> Diversity
  Bioclimate -> UnderstoryDensity -> Diversity
  Bioclimate -> Diversity
  Elevation -> Bioclimate
  Elevation -> ForestStructure
  Elevation -> UnderstoryDensity
  Elevation -> SiteAccessibility
  Topography -> UnderstoryDensity
  Topography -> ForestStructure
  Topography -> SiteAccessibility
  Topography -> Diversity
  HDI -> Diversity
  PA [exposure]
  Diversity [outcome]
               }"
)

# Organize the data into a visual hierarchy
coordinates( dagBrodie ) <-  list(x = c(Diversity = 3, 
                                        UnderstoryDensity = 1, 
                                        ForestStructure = 2, 
                                        PA = 3, 
                                        SiteAccessibility = 4, 
                                        HDI = 5, 
                                        Bioclimate = 2, 
                                        Elevation = 3, 
                                        Topography = 4
                                        ),
                                  y = c(Diversity = 3, 
                                        UnderstoryDensity = 2, 
                                        ForestStructure = 2, 
                                        PA = 2, 
                                        SiteAccessibility = 2, 
                                        HDI = 2, 
                                        Bioclimate = 1, 
                                        Elevation = 1, 
                                        Topography = 1
                                        ))

# Plot the DAG to confirm the visual structure and exposure
ggdag_status(dagBrodie, text_col="#e2e4e6", text_size = 3.5, node_size = 20) + 
    theme_dag() +
    xlim(0, 6)
# Identify the set of adjustment variables needed to identify 
# the effect of PA on biodiversity 
adjustmentSets(dagBrodie)

```


```{r clean_data, echo = FALSE}
# results = 'hide', message = FALSE, eval = FALSE,
# Load Revised Data ------------------------------------------------------------
# Birds ------------------------------------------------------------------------
rm(list = ls())
dat_birds <- data.frame(read.csv(here("data/raw/public/training/bird_data_corrected_240122.csv"), header = T))

# Mammals ----------------------------------------------------------------------
dat_mammals <- data.frame(read.csv(here("data/raw/public/training/mammal_data_corrected_240122.csv"), header = T))

# Load and Clean Original Data -------------------------------------------------
# Birds ------------------------------------------------------------------------
m01 <- mean(dat_birds$utm_east,na.rm = T);
s01 <- sd(dat_birds$utm_east,na.rm = T); 
dat_birds$utm_east.z <- (dat_birds$utm_east-m01)/s01

m02 <- mean(dat_birds$utm_north,na.rm = T);
s02 <- sd(dat_birds$utm_north,na.rm = T);
dat_birds$utm_north.z <- (dat_birds$utm_north-m02)/s02

m03<-mean(dat_birds$HDI,na.rm=T);
s03<-sd(dat_birds$HDI,na.rm=T);
dat_birds$HDI.z<-(dat_birds$HDI-m03)/s03

m06<-mean(dat_birds$elev,na.rm=T);
s06<-sd(dat_birds$elev,na.rm=T);
dat_birds$elev.z<-(dat_birds$elev-m06)/s06

m06f<-mean(dat_birds$TPI,na.rm=T);
s06f<-sd(dat_birds$TPI,na.rm=T);
dat_birds$TPI.z<-(dat_birds$TPI-m06f)/s06f

m08<-mean(dat_birds$access_log10,na.rm=T);
s08<-sd(dat_birds$access_log10,na.rm=T);
dat_birds$access_log10.z<-(dat_birds$access_log10-m08)/s08

m09<-mean(dat_birds$bio01,na.rm=T);
s09<-sd(dat_birds$bio01,na.rm=T);
dat_birds$bio01.z<-(dat_birds$bio01-m09)/s09

# these two variables will be used in subsequent analysis so renamed
# ---
m44_birds<-mean(dat_birds$PA_size_km2,na.rm=T); 
s44_birds<-sd(dat_birds$PA_size_km2,na.rm=T); 
dat_birds$PA_size_km2.z<-(dat_birds$PA_size_km2-m44_birds)/s44_birds

m45_birds<-mean(dat_birds$dist_to_PA,na.rm=T);
s45_birds<-sd(dat_birds$dist_to_PA,na.rm=T);
dat_birds$dist_to_PA.z<-(dat_birds$dist_to_PA-m45_birds)/s45_birds
# ---

m47<-mean(dat_birds$rh_95_a0.pred,na.rm=T);
s47<-sd(dat_birds$rh_95_a0.pred,na.rm=T);
dat_birds$rh_95_a0.pred.z<-(dat_birds$rh_95_a0.pred-m47)/s47

m51<-mean(dat_birds$pai_a0.pred,na.rm=T);
s51<-sd(dat_birds$pai_a0.pred,na.rm=T);
dat_birds$pai_a0.pred.z<-(dat_birds$pai_a0.pred-m51)/s51

m53<-mean(dat_birds$fhd_pai_1m_a0.pred,na.rm=T);
s53<-sd(dat_birds$fhd_pai_1m_a0.pred,na.rm=T);
dat_birds$fhd_pai_1m_a0.pred.z<-(dat_birds$fhd_pai_1m_a0.pred-m53)/s53

m55<-mean(dat_birds$cover_a0.pred,na.rm=T);
s55<-sd(dat_birds$cover_a0.pred,na.rm=T);
dat_birds$cover_a0.pred.z<-(dat_birds$cover_a0.pred-m55)/s55

m60<-mean(dat_birds$agbd_a0.pred,na.rm=T);
s60<-sd(dat_birds$agbd_a0.pred,na.rm=T);
dat_birds$agbd_a0.pred.z<-(dat_birds$agbd_a0.pred-m60)/s60

dat_birds1 <- subset(dat_birds, select = c(station, country, utm_east, utm_north, utm_east.z, utm_north.z, 
	elev.z, TPI.z, HDI.z, access_log10.z, bio01.z, 
	PA, PA_size_km2.z, dist_to_PA.z, Hansen_recentloss, 
	rh_95_a0.pred.z, pai_a0.pred.z, fhd_pai_1m_a0.pred.z, cover_a0.pred.z, agbd_a0.pred.z,  
	maxFRic, asymptPD, SR.mean)) 
dat_birds1 <- subset(dat_birds1, !is.na(dat_birds1$bio01.z))
d_birds1 <- subset(dat_birds1, select = -c(dist_to_PA.z))
d_birds1 <- d_birds1[complete.cases(d_birds1), ]
d_birds1$gedi.m <- d_birds1$rh_95_a0.pred.z 
d_birds1 <- subset(d_birds1, Hansen_recentloss == 0)

# Mammals ----------------------------------------------------------------------
m01<-mean(dat_mammals$utm_east,na.rm=T); 
s01<-sd(dat_mammals$utm_east,na.rm=T); 
dat_mammals$utm_east.z<-(dat_mammals$utm_east-m01)/s01

m02<-mean(dat_mammals$utm_north,na.rm=T); 
s02<-sd(dat_mammals$utm_north,na.rm=T); 
dat_mammals$utm_north.z<-(dat_mammals$utm_north-m02)/s02

m03<-mean(dat_mammals$HDI,na.rm=T); 
s03<-sd(dat_mammals$HDI,na.rm=T); 
dat_mammals$HDI.z<-(dat_mammals$HDI-m03)/s03

m06<-mean(dat_mammals$elev,na.rm=T); 
s06<-sd(dat_mammals$elev,na.rm=T); 
dat_mammals$elev.z<-(dat_mammals$elev-m06)/s06

m06f<-mean(dat_mammals$TPI,na.rm=T); 
s06f<-sd(dat_mammals$TPI,na.rm=T); 
dat_mammals$TPI.z<-(dat_mammals$TPI-m06f)/s06f

m08<-mean(dat_mammals$access_log10,na.rm=T); 
s08<-sd(dat_mammals$access_log10,na.rm=T); 
dat_mammals$access_log10.z<-(dat_mammals$access_log10-m08)/s08

m09<-mean(dat_mammals$bio01,na.rm=T); 
s09<-sd(dat_mammals$bio01,na.rm=T); 
dat_mammals$bio01.z<-(dat_mammals$bio01-m09)/s09

# same here
# ---
m44_mammals<-mean(dat_mammals$PA_size_km2,na.rm=T); 
s44_mammals<-sd(dat_mammals$PA_size_km2,na.rm=T); 
dat_mammals$PA_size_km2.z<-(dat_mammals$PA_size_km2-m44_mammals)/s44_mammals

m45_mammals<-mean(dat_mammals$dist_to_PA,na.rm=T); 
s45_mammals<-sd(dat_mammals$dist_to_PA,na.rm=T); 
dat_mammals$dist_to_PA.z<-(dat_mammals$dist_to_PA-m45_mammals)/s45_mammals
# ---

m47<-mean(dat_mammals$rh_95_a0.pred,na.rm=T); 
s47<-sd(dat_mammals$rh_95_a0.pred,na.rm=T); 
dat_mammals$rh_95_a0.pred.z<-(dat_mammals$rh_95_a0.pred-m47)/s47

m51<-mean(dat_mammals$pai_a0.pred,na.rm=T);
s51<-sd(dat_mammals$pai_a0.pred,na.rm=T);
dat_mammals$pai_a0.pred.z<-(dat_mammals$pai_a0.pred-m51)/s51

m53<-mean(dat_mammals$fhd_pai_1m_a0.pred,na.rm=T);
s53<-sd(dat_mammals$fhd_pai_1m_a0.pred,na.rm=T);
dat_mammals$fhd_pai_1m_a0.pred.z<-(dat_mammals$fhd_pai_1m_a0.pred-m53)/s53

m55<-mean(dat_mammals$cover_a0.pred,na.rm=T);
s55<-sd(dat_mammals$cover_a0.pred,na.rm=T);
dat_mammals$cover_a0.pred.z<-(dat_mammals$cover_a0.pred-m55)/s55

m60<-mean(dat_mammals$agbd_a0.pred,na.rm=T);
s60<-sd(dat_mammals$agbd_a0.pred,na.rm=T);
dat_mammals$agbd_a0.pred.z<-(dat_mammals$agbd_a0.pred-m60)/s60

dat_mammals1 <- subset(dat_mammals, select = c(study_area, station, country, utm_east, utm_north, utm_east.z, utm_north.z, 
	elev.z, TPI.z, HDI.z, access_log10.z, bio01.z, 
	PA, PA_size_km2.z, dist_to_PA.z, Hansen_recentloss, 
	rh_95_a0.pred.z, pai_a0.pred.z, fhd_pai_1m_a0.pred.z, cover_a0.pred.z, agbd_a0.pred.z,  
	maxFRic, asymptPD, SR.mean)) 
dat_mammals1 <- subset(dat_mammals1, !is.na(dat_mammals1$bio01.z))
d_mammals1 <- subset(dat_mammals1, select = -c(dist_to_PA.z))
d_mammals1 <- d_mammals1[complete.cases(d_mammals1), ]
d_mammals1$gedi.m <- d_mammals1$rh_95_a0.pred.z 
d_mammals1 <- subset(d_mammals1, Hansen_recentloss == 0)
```

To assess **OR-Ho-1** we reproduced the propensity score matching procedure and linear mixed-effects modeling conducted by the Brodie et al. for each the three biodiversity response variables for each taxon. 
This procedure resulted in six fitted regressions.
Our results (Table 3) correspond to the top third of Table 1 of corrected supplemental materials presented by Brodie et al.. 
While we were not able to computationally reproduce their exact coefficient values, our results are similar in magnitude, direction, and statistical significance. 
Of principle interest, we were able to reproduce the statistical results for the PA treatment for both birds and mammals.
Bird models produced significant positive effects for location within a PA, while no significant effects were observed for mammals.

```{r rpr_cor_eff, echo = FALSE,  include = TRUE}
# Brodies efficacy code Bird ---------------------------------------------------
#--------------------------- PD ------------------------------------------------
d_birds1_pd <- d_birds1
d_birds1_pd$y <- d_birds1_pd$asymptPD

#----- All sites - PA effect - Matched -----
d_birds1b <- subset(d_birds1_pd, station != "L2422371")
d_birds1b <- subset(d_birds1b, station != "L3776738")
d_birds1b <- subset(d_birds1b, station != "L2521761")
d_birds1b <- subset(d_birds1b, station != "L6127181")
d_birds1b <- subset(d_birds1b, station != "L3865754")
matchb_birds <- MatchIt::matchit(PA ~ utm_east.z + utm_north.z + gedi.m + access_log10.z + HDI.z, 
	data = d_birds1b, method = "full", distance = "glm", link = "probit", replace = F)
dmatchb_birds_pd <- match.data(matchb_birds)
mm02_birds_pd <- nlme::lme(y ~ gedi.m + access_log10.z + HDI.z + PA, random = list(~1 | country), data = dmatchb_birds_pd, weights = ~I(1/weights), 
	correlation = corExp(form = ~utm_east + utm_north, nugget = TRUE))

#--------------------------- FR ------------------------------------------------
d_birds1_fr <- d_birds1
d_birds1_fr$y <- d_birds1_fr$maxFR

#----- All sites - PA effect - Matched -----
d_birds1b <- subset(d_birds1_fr, station != "L921125")
d_birds1b <- subset(d_birds1b, station != "L2422371")
d_birds1b <- subset(d_birds1b, station != "L4331944")
d_brids1b <- subset(d_birds1b, station != "L13465594")
matchb_birds <- MatchIt::matchit(PA ~ utm_east.z + utm_north.z + gedi.m + access_log10.z + HDI.z, 
	data = d_birds1b, method = "full", distance = "glm", link = "probit", replace = F)
dmatchb_birds_fr <- match.data(matchb_birds)
mm02_birds_fr <- nlme::lme(y ~ gedi.m + access_log10.z + HDI.z + PA, random = list(~1 | country), data = dmatchb_birds_fr, weights = ~I(1/weights), 
	correlation = corExp(form = ~utm_east + utm_north, nugget = TRUE))

#--------------------------- SR ------------------------------------------------
d_birds1_sr <- d_birds1
d_birds1_sr$y <- d_birds1_sr$SR.mean

#----- All sites - PA effect - Matched -----
d_birds1b <- subset(d_birds1_sr, station != "L4789498")
d_birds1b <- subset(d_birds1b, station != "L921125")
d_birds1b <- subset(d_birds1b, station != "L1122096")
d_birds1b <- subset(d_birds1b, station != "L7010824")
d_birds1b <- subset(d_birds1b, station != "L3865754")
d_birds1b <- subset(d_birds1b, station != "L3776738")
matchb_birds <- MatchIt::matchit(PA ~ utm_east.z + utm_north.z + gedi.m + access_log10.z + HDI.z, 
	data = d_birds1b, method = "full", distance = "glm", link = "probit", replace = F)
dmatchb_birds_sr <- match.data(matchb_birds)
mm02_birds_sr <- nlme::lme(y ~ gedi.m + access_log10.z + HDI.z + PA, random = list(~1 | country), data = dmatchb_birds_sr, weights = ~I(1/weights), 
	correlation = corExp(form = ~utm_east + utm_north, nugget = TRUE))


# Brodies efficacy code Mammals ------------------------------------------------
#--------------------------- PD ------------------------------------------------
d_mammals1_pd <- d_mammals1
d_mammals1_pd$y <- d_mammals1_pd$asymptPD

#----- All sites - PA effect - Matched -----
match_mammals2 <- MatchIt::matchit(PA ~ utm_east.z + utm_north.z + gedi.m + access_log10.z + HDI.z, 
	data = d_mammals1_pd, method = "full", distance = "glm", link = "probit", replace = F)
# summary(match_mammals2)
dmatch_mammals_pd <- match.data(match_mammals2)
mm02_mammals_pd <- nlme::lme(y ~ gedi.m + access_log10.z + HDI.z + PA, 
	random = list(~1 | country, ~1 | study_area), data = dmatch_mammals_pd, weights = ~I(1/weights), 
	correlation = corExp(form = ~utm_east + utm_north, nugget = TRUE))

#--------------------------- FR ------------------------------------------------
d_mammals1_fr <- d_mammals1
d_mammals1_fr$y <- d_mammals1_fr$maxFR

#----- All sites - PA effect - Matched -----
match_mammals2 <- MatchIt::matchit(PA ~ utm_east.z + utm_north.z + gedi.m + access_log10.z + HDI.z, 
	data = d_mammals1_fr, method = "full", distance = "glm", link = "probit", replace = F)
dmatch_mammals_fr <- match.data(match_mammals2)
mm02_mammals_fr <- nlme::lme(y ~ gedi.m + access_log10.z + HDI.z + PA, 
	random = list(~1 | country, ~1 | study_area), data = dmatch_mammals_fr, weights = ~I(1/weights), 
	correlation = corExp(form = ~utm_east + utm_north, nugget = TRUE))

#--------------------------- SR ------------------------------------------------
d_mammals1_sr <- d_mammals1
d_mammals1_sr$y <- d_mammals1_sr$SR.mean

#----- All sites - PA effect - Matched -----
match_mammals2 <- MatchIt::matchit(PA ~ utm_east.z + utm_north.z + gedi.m + access_log10.z + HDI.z, 
	data = d_mammals1_sr, method = "full", distance = "glm", link = "probit", replace = F)
dmatch_mammals_sr <- match.data(match_mammals2)
mm02_mammals_sr <- nlme::lme(y ~ gedi.m + access_log10.z + HDI.z + PA, 
	random = list(~1 | country, ~1 | study_area), data = dmatch_mammals_sr, weights = ~I(1/weights), 
	correlation = corExp(form = ~utm_east + utm_north, nugget = TRUE))

# create a list to store these models ------------------------------------------
bird_eff_models <- list(PD = mm02_birds_pd, FR = mm02_birds_fr, SR = mm02_birds_sr)
mammals_eff_models <- list(PD = mm02_mammals_pd, FR = mm02_mammals_fr, SR = mm02_mammals_sr)
efficacy_models <- c(bird_eff_models, mammals_eff_models)

```


```{r rpr_cor_eff_tab_final, echo = FALSE, message = FALSE, warning = FALSE, eval = TRUE}

var_cvt <- data.frame(
    term = c("R2", "(Intercept)", "gedi.m", "access_log10.z", 
             "HDI.z", "PA"),
    Variable = c("$R^{2}$", "Intercept", "Forest canopy height",
                 "Site accessibility", "HDI", "PA"))

mods <- list("bird" = bird_eff_models, 
             "mammal" = mammals_eff_models)

coefs <- lapply(names(mods), function(taxon){
    models <- mods[[taxon]]
    lapply(names(models), function(nm){
        # extract names to know which model it is
        # in the case for efficacy models
        # create uppercase y variable names - SR, FR, PD
        var_nm <- toupper(strsplit(nm, "_")[[1]])
        # Extract effect names - All sites for efficacy models
        effect_nm <- "All sites"
        # compute r.squared values
        r_square <- r.squaredGLMM(models[[nm]])[[2]]
        
        # clean model output into into a tidy data frame with broom.mixed
        broom.mixed::tidy(
            models[[nm]], effects='fixed', conf.int = TRUE) %>%
            # add a column into the dataframe called report_value to store
            # all statistics to be reported
            mutate(report_value = sprintf("%.3f\n(%.3f; %.3f)", 
                                          estimate, std.error, p.value)) %>% 
            # select columns to keep
            select(term, report_value) %>% 
            # add the of R2 values
            rbind(c("R2", sprintf("%.3f", r_square)), .) %>%
            # join the data frame with var_cvt to add the column of converted names
            left_join(var_cvt, by = "term") %>% 
            # add two new columns to store variable names and effect names
            mutate(var_nm = var_nm, Effect = effect_nm) %>% 
            select(Effect, Variable, report_value, var_nm)
    }) %>% 
        # after doing this for each y (SR, FR, PD) and each taxon (bird, mammal)
        # combine them using bind rows
        bind_rows() %>% 
        # change var_nm to be of factor type
        mutate(var_nm = factor(var_nm, levels = c("SR", "FR", "PD"))) %>% 
        # reorder rows using column values
        arrange(var_nm) %>% 
        # transpose the data frame
        pivot_wider(names_from = var_nm, values_from = report_value)
})

# join results of birds and mammals into a single data frame
coefs <- left_join(coefs[[1]], coefs[[2]], by = c("Variable", "Effect"),
                       suffix = sprintf(".%s", c("Birds", "Mammals")))

# Manipulate the table
effects <- unique(coefs$Effect)
# identify which rows are results for which effect
row_1 <- which(coefs$Effect == effects[1])
# and then remove the column of Effect
coefs <- coefs %>% 
    select(-Effect) %>%
    mutate_all(linebreak)

# Bold cells that have significant treatment effects
# first, get row ids for rows displaying results of the model of interest
row_ids <- which(coefs$Variable %in% c("PA"))
# second,  extract row(s) with identified row ids
detec_sig <- coefs[row_ids, -1]
# then apply a function to detect their significance
# for each column, extract value after ; sign
# using a regular expression I don't understand but it works great
detec_sig <- do.call(cbind, lapply(1:ncol(detec_sig), function(i){
    as.numeric(sapply(detec_sig[[i]], function(x){
        str_extract(x, "(?<=;[[:space:]]).*?(?=\\))")}))
}))
# convert it into boolean class, TRUE -- significant, FALSE -- insignificant
detec_sig <- detec_sig <= 0.05
# create a matrix of whether to bold the cell or not
bold_ids <- matrix(data = FALSE, nrow = nrow(coefs), ncol = ncol(coefs))
bold_ids[row_ids, 1:ncol(detec_sig) + 1] <- detec_sig

# use cell_spec to bold cells we need to bold
for (i in 1:nrow(bold_ids)){
    for (j in 1:ncol(bold_ids)){
        if (bold_ids[i, j] == TRUE){
            coefs[i, j] <- cell_spec(coefs[i, j], bold = T, escape = FALSE)
        }
    }
}

# Make the kable
names(coefs) <- c("Variable", "SR", "FR", "PD", "SR", "FR", "PD")
cap <- paste0("Reproduction results from mixed-effects linear regression for ",
              "species richness (SR), functional richness (FR), ",
              "and phylogenetic diversity (PD). Following Brodie et al., 
              bolding indicates predictors with estimated coefficients with 
              p<0.05")
coefs %>%
    kableExtra::kbl(escape = FALSE, full_width = FALSE, booktabs = TRUE,
                    caption = cap) %>% 
    kable_paper() %>% 
    kable_styling(latex_options = c("scale_down", "hold_position"), 
                  font_size = 10) %>% 
    # pack_rows can group rows into a category 
    # we are grouping them by effects
    pack_rows(effects[1], min(row_1), max(row_1), latex_gap_space = "1em") %>%
    add_header_above(c(" " = 1, "Bird" = 3, "Mammal" = 3),
                     align = "c") 
#%>%
#    save_kable(here('results/figures/RPR-cor-eff-table.png'))
```

To assess **OR-Ho-2a** and **OR-Ho-2b** we reproduced the propensity score matching procedure and linear mixed-effects modeling of PA size and PA distance spillovers for each the three biodiversity response variables for each taxon.
This produced 12 fitted regressions.
Our results (Table 4) match the bottom two-thirds of Table 1 of corrected supplemental materials presented by Brodie et al..
We were again unable to computationally reproduce the exact coefficient values for the 'PA size' effects or the 'Distance to PA' effects, but did produce coefficients with similar directions, magnitudes, and statistical significance. 
The one difference between our results and the original authors was the coefficient for the distance to PA estimated for birds using SR. 

```{r rpr_cor_spill, echo = FALSE, results = 'hide', message = FALSE, eval = TRUE}

# Brodies spillover effect code Bird -------------------------------------------
#--------------------------- PD ------------------------------------------------
# PA size ----------------------------------------------------------------------
d_birds3 <- subset(d_birds1_pd, PA == 0)
tmp <- subset(dat_birds1, select = c(station, dist_to_PA.z))
d_birds3 <- left_join(d_birds3, tmp, by = "station")
d_birds3$PA_size_km2 <- (d_birds3$PA_size_km2.z * s44_birds) + m44_birds
PA_size_threshold.z <- (500 - m44_birds) / s44_birds
d_birds3$BigPA <- ifelse(d_birds3$PA_size_km2.z < PA_size_threshold.z, 0, 1)
d_birds3b <- subset(d_birds3, station != "L1084299")
d_birds3b <- subset(d_birds3b, station != "L4225511")
d_birds3b <- subset(d_birds3b, station != "L3846512")
d_birds3b <- subset(d_birds3b, station != "L2129865")
d_birds3b <- subset(d_birds3b, station != "L3267752")
matchb_birds_size_pd <- MatchIt::matchit(BigPA ~ utm_north.z + utm_east.z + gedi.m + access_log10.z + HDI.z + 
	dist_to_PA.z, data = d_birds3b, method = "full", distance = "glm",
	link = "probit", replace = F)
dmatchb_birds_size_pd <- match.data(matchb_birds_size_pd)
mm02b_birds_size_pd <- nlme::lme(y ~ gedi.m + access_log10.z + HDI.z + dist_to_PA.z + BigPA, random = list(~1 | country),
	data = dmatchb_birds_size_pd, weights = ~I(1/weights), correlation = corExp(form = ~utm_east + utm_north, nugget = TRUE))

# PA distance ------------------------------------------------------------------
d_birds3b$dist_to_PA <- (d_birds3b$dist_to_PA.z * s45_birds) + m45_birds
PA_dist_threshold <- 2 # threshold distance (km)
d_birds3b$CloseToPA <- ifelse(d_birds3b$dist_to_PA > PA_dist_threshold, 0, 1)
match2_birds_dist_pd <- MatchIt::matchit(CloseToPA ~ utm_north.z + utm_east.z + gedi.m + access_log10.z + HDI.z + 
	PA_size_km2.z, data = d_birds3b, method = "full", distance = "glm",
	link = "probit", replace = F)
dmatch_birds_dist_pd <- match.data(match2_birds_dist_pd)
mm02d_birds_dist_pd <- nlme::lme(y ~ gedi.m + access_log10.z + HDI.z + PA_size_km2.z + CloseToPA, random = list(~1 | country),
	data = dmatch_birds_dist_pd, weights = ~I(1/weights), correlation = corExp(form = ~utm_east + utm_north, nugget = TRUE))

#--------------------------- FR ------------------------------------------------
# PA size ----------------------------------------------------------------------
d_birds3 <- subset(d_birds1_fr, PA == 0)
tmp <- subset(dat_birds1, select = c(station, dist_to_PA.z))
d_birds3 <- left_join(d_birds3, tmp, by = "station")
d_birds3$PA_size_km2 <- (d_birds3$PA_size_km2.z * s44_birds) + m44_birds
PA_size_threshold.z <- (500 - m44_birds) / s44_birds
d_birds3$BigPA <- ifelse(d_birds3$PA_size_km2.z < PA_size_threshold.z, 0, 1)
d_birds3b <- subset(d_birds3, station != "L4225511")
d_birds3b <- subset(d_birds3b, station != "L5969878")
d_birds3b <- subset(d_birds3b, station != "L3267752")
d_birds3b <- subset(d_birds3b, station != "L4331944")
d_birds3b <- subset(d_birds3b, station != "L13465594")
d_birds3b <- subset(d_birds3b, station != "L1084299")
matchb_birds_size_fr <- MatchIt::matchit(BigPA ~ utm_north.z + utm_east.z + gedi.m + access_log10.z + HDI.z + 
	dist_to_PA.z, data = d_birds3b, method = "full", distance = "glm",
	link = "probit", replace = F)
dmatchb_birds_size_fr <- match.data(matchb_birds_size_fr)
mm02b_birds_size_fr <- nlme::lme(y ~ gedi.m + access_log10.z + HDI.z + dist_to_PA.z + BigPA, random = list(~1 | country),
	data = dmatchb_birds_size_fr, weights = ~I(1/weights), correlation = corExp(form = ~utm_east + utm_north, nugget = TRUE))

# PA distance ------------------------------------------------------------------
d_birds3b$dist_to_PA <- (d_birds3b$dist_to_PA.z * s45_birds) + m45_birds
PA_dist_threshold <- 2 # threshold distance (km)
d_birds3b$CloseToPA <- ifelse(d_birds3b$dist_to_PA > PA_dist_threshold, 0, 1)
match2_birds_dist_fr <- MatchIt::matchit(CloseToPA ~ utm_north.z + utm_east.z + gedi.m + access_log10.z + HDI.z + 
	PA_size_km2.z, data = d_birds3b, method = "full", distance = "glm",
	link = "probit", replace = F)
dmatch_birds_dist_fr <- match.data(match2_birds_dist_fr)
mm02d_birds_dist_fr <- nlme::lme(y ~ gedi.m + access_log10.z + HDI.z + PA_size_km2.z + CloseToPA, random = list(~1 | country),
	data = dmatch_birds_dist_fr, weights = ~I(1/weights), correlation = corExp(form = ~utm_east + utm_north, nugget = TRUE))


#--------------------------- SR ------------------------------------------------
# PA size ----------------------------------------------------------------------
d_birds3 <- subset(d_birds1_sr, PA == 0)
tmp <- subset(dat_birds1, select = c(station, dist_to_PA.z))
d_birds3 <- left_join(d_birds3, tmp, by = "station")
d_birds3$PA_size_km2 <- (d_birds3$PA_size_km2.z * s44_birds) + m44_birds
PA_size_threshold.z <- (500 - m44_birds) / s44_birds
d_birds3$BigPA <- ifelse(d_birds3$PA_size_km2.z < PA_size_threshold.z, 0, 1)
d_birds3b <- subset(d_birds3, station != "L4225511")
d_birds3b <- subset(d_birds3b, station != "L5624588")
d_birds3b <- subset(d_birds3b, station != "L3321319")
d_birds3b <- subset(d_birds3b, station != "L14087870")
matchb_birds_size_sr <- MatchIt::matchit(BigPA ~ utm_north.z + utm_east.z + gedi.m + access_log10.z + HDI.z + 
	dist_to_PA.z, data = d_birds3b, method = "full", distance = "glm",
	link = "probit", replace = F)
dmatchb_birds_size_sr <- match.data(matchb_birds_size_sr)
mm02b_birds_size_sr <- nlme::lme(y ~ gedi.m + access_log10.z + HDI.z + dist_to_PA.z + BigPA, random = list(~1 | country),
	data = dmatchb_birds_size_sr, weights = ~I(1/weights), correlation = corExp(form = ~utm_east + utm_north, nugget = TRUE))

# PA distance ------------------------------------------------------------------
d_birds3b$dist_to_PA <- (d_birds3b$dist_to_PA.z * s45_birds) + m45_birds
PA_dist_threshold <- 2 # threshold distance (km)
d_birds3b$CloseToPA <- ifelse(d_birds3b$dist_to_PA > PA_dist_threshold, 0, 1)
match2_birds_dist_sr <- MatchIt::matchit(CloseToPA ~ utm_north.z + utm_east.z + gedi.m + access_log10.z + HDI.z + 
	PA_size_km2.z, data = d_birds3b, method = "full", distance = "glm",
	link = "probit", replace = F)
dmatch_birds_dist_sr <- match.data(match2_birds_dist_sr)
mm02d_birds_dist_sr <- nlme::lme(y ~ gedi.m + access_log10.z + HDI.z + PA_size_km2.z + CloseToPA, random = list(~1 | country),
	data = dmatch_birds_dist_sr, weights = ~I(1/weights), correlation = corExp(form = ~utm_east + utm_north, nugget = TRUE))


# Brodies spillover effect code Mammals ----------------------------------------
#--------------------------- PD ------------------------------------------------
# PA size ----------------------------------------------------------------------
d_mammals3 <- subset(d_mammals1_pd, PA == 0)
tmp <- subset(dat_mammals1, select = c(station, dist_to_PA.z))
d_mammals3 <- left_join(d_mammals3, tmp, by = "station")
d_mammals3$PA_size_km2 <- (d_mammals3$PA_size_km2.z * s44_mammals) + m44_mammals
PA_size_threshold.z <- (500 - m44_mammals) / s44_mammals
d_mammals3$BigPA <- ifelse(d_mammals3$PA_size_km2.z < PA_size_threshold.z, 0, 1)
d_mammals3b <- subset(d_mammals3, station != "WM-OP009")
d_mammals3b <- subset(d_mammals3b, station != "WM-HCV003")
d_mammals3b <- subset(d_mammals3b, station != "C24A25")
d_mammals3b <- subset(d_mammals3b, station != "C1A09")
d_mammals3b <- subset(d_mammals3b, station != "C1B12")
matchb_mammals_size_pd <- MatchIt::matchit(BigPA ~ utm_north.z + utm_east.z + gedi.m + access_log10.z + HDI.z + 
	dist_to_PA.z, data = d_mammals3b, method = "full", distance = "glm",
	link = "probit", replace = F)
dmatchb_mammals_size_pd <- match.data(matchb_mammals_size_pd)
mm02b_mammals_size_pd <- nlme::lme(y ~ gedi.m + access_log10.z + HDI.z + dist_to_PA.z + BigPA, random = list(~1 | country, ~1 | study_area),
	data = dmatchb_mammals_size_pd, weights = ~I(1/weights), correlation = corExp(form = ~utm_east + utm_north, nugget = TRUE))

# PA distance ------------------------------------------------------------------
d_mammals3b$dist_to_PA <- (d_mammals3b$dist_to_PA.z * s45_mammals) + m45_mammals
PA_dist_threshold <- 2 
d_mammals3b$CloseToPA <- ifelse(d_mammals3b$dist_to_PA > PA_dist_threshold, 0, 1)
match2_mammals_dist_pd <- MatchIt::matchit(CloseToPA ~ utm_north.z + utm_east.z + gedi.m + access_log10.z + HDI.z + 
	PA_size_km2.z, data = d_mammals3b, method = "full", distance = "glm",
	link = "probit", replace = F)
dmatch_mammals_dist_pd <- match.data(match2_mammals_dist_pd)
mm02d_mammals_dist_pd <- nlme::lme(y ~ gedi.m + access_log10.z + HDI.z + PA_size_km2.z + CloseToPA, random = list(~1 | study_area),
	data = dmatch_mammals_dist_pd, weights = ~I(1/weights), correlation = corExp(form = ~utm_east + utm_north, nugget = TRUE))


#--------------------------- FR ------------------------------------------------
# PA size ----------------------------------------------------------------------
d_mammals3 <- subset(d_mammals1_fr, PA == 0)
tmp <- subset(dat_mammals1, select = c(station, dist_to_PA.z))
d_mammals3 <- left_join(d_mammals3, tmp, by = "station")
d_mammals3$PA_size_km2 <- (d_mammals3$PA_size_km2.z * s44_mammals) + m44_mammals
PA_size_threshold.z <- (500 - m44_mammals) / s44_mammals
d_mammals3$BigPA <- ifelse(d_mammals3$PA_size_km2.z < PA_size_threshold.z, 0, 1)
d_mammals3b <- subset(d_mammals3, station != "Bal013a")
d_mammals3b <- subset(d_mammals3b, station != "Bal017a")
d_mammals3b <- subset(d_mammals3b, station != "C1CT21")
matchb_mammals_size_fr <- MatchIt::matchit(BigPA ~ utm_north.z + utm_east.z + gedi.m + access_log10.z + HDI.z + 
	dist_to_PA.z, data = d_mammals3b, method = "full", distance = "glm",
	link = "probit", replace = F)
dmatchb_mammals_size_fr <- match.data(matchb_mammals_size_fr)
mm02b_mammals_size_fr <- nlme::lme(y ~ gedi.m + access_log10.z + HDI.z + dist_to_PA.z + BigPA, random = list(~1 | country, ~1 | study_area),
	data = dmatchb_mammals_size_fr, weights = ~I(1/weights), correlation = corExp(form = ~utm_east + utm_north, nugget = TRUE))

# PA distance ------------------------------------------------------------------
d_mammals3b$dist_to_PA <- (d_mammals3b$dist_to_PA.z * s45_mammals) + m45_mammals
PA_dist_threshold <- 2 
d_mammals3b$CloseToPA <- ifelse(d_mammals3b$dist_to_PA > PA_dist_threshold, 0, 1)
match2_mammals_dist_fr <- MatchIt::matchit(CloseToPA ~ utm_north.z + utm_east.z + gedi.m + access_log10.z + HDI.z + 
	PA_size_km2.z, data = d_mammals3b, method = "full", distance = "glm",
	link = "probit", replace = F)
dmatch_mammals_dist_fr <- match.data(match2_mammals_dist_fr)
mm02d_mammals_dist_fr <- nlme::lme(y ~ gedi.m + access_log10.z + HDI.z + PA_size_km2.z + CloseToPA, random = list(~1 | country, ~1 | study_area),
	data = dmatch_mammals_dist_fr, weights = ~I(1/weights), correlation = corExp(form = ~utm_east + utm_north, nugget = TRUE))


#--------------------------- SR ------------------------------------------------
# PA size ----------------------------------------------------------------------
d_mammals3 <- subset(d_mammals1_sr, PA == 0)
tmp <- subset(dat_mammals1, select = c(station, dist_to_PA.z))
d_mammals3 <- left_join(d_mammals3, tmp, by = "station")
d_mammals3$PA_size_km2 <- (d_mammals3$PA_size_km2.z * s44_mammals) + m44_mammals
PA_size_threshold.z <- (500 - m44_mammals) / s44_mammals
d_mammals3$BigPA <- ifelse(d_mammals3$PA_size_km2.z < PA_size_threshold.z, 0, 1)
d_mammals3b <- subset(d_mammals3, station != "Bal011")
d_mammals3b <- subset(d_mammals3b, station != "C1CT50")
d_mammals3b <- subset(d_mammals3b, station != "C24A25")
matchb_mammals_size_sr <- MatchIt::matchit(BigPA ~ utm_north.z + utm_east.z + gedi.m + access_log10.z + HDI.z + 
	dist_to_PA.z, data = d_mammals3b, method = "full", distance = "glm",
	link = "probit", replace = F)
dmatchb_mammals_size_sr <- match.data(matchb_mammals_size_sr)
mm02b_mammals_size_sr <- nlme::lme(y ~ gedi.m + access_log10.z + HDI.z + dist_to_PA.z + BigPA, random = list(~1 | country, ~1 | study_area),
	data = dmatchb_mammals_size_sr, weights = ~I(1/weights), correlation = corExp(form = ~utm_east + utm_north, nugget = TRUE))

# PA distance ------------------------------------------------------------------
d_mammals3b$dist_to_PA <- (d_mammals3b$dist_to_PA.z * s45_mammals) + m45_mammals
PA_dist_threshold <- 2 
d_mammals3b$CloseToPA <- ifelse(d_mammals3b$dist_to_PA > PA_dist_threshold, 0, 1)
match2_mammals_dist_sr <- MatchIt::matchit(CloseToPA ~ utm_north.z + utm_east.z + gedi.m + access_log10.z + HDI.z + 
	PA_size_km2.z, data = d_mammals3b, method = "full", distance = "glm",
	link = "probit", replace = F)
dmatch_mammals_dist_sr <- match.data(match2_mammals_dist_sr)
mm02d_mammals_dist_sr <- nlme::lme(y ~ gedi.m + access_log10.z + HDI.z + PA_size_km2.z + CloseToPA, random = list(~1 | country, ~1 | study_area),
	data = dmatch_mammals_dist_sr, weights = ~I(1/weights), correlation = corExp(form = ~utm_east + utm_north, nugget = TRUE))


# create a list to store these models ------------------------------------------
bird_size_models <- list(PD_size = mm02b_birds_size_pd, FR_size = mm02b_birds_size_fr, SR_size = mm02b_birds_size_sr)
mammals_size_models <- list(PD_size = mm02b_mammals_size_pd, FR_size = mm02b_mammals_size_fr, SR_size = mm02b_mammals_size_sr)

bird_dist_models <- list(PD_dist = mm02d_birds_dist_pd, FR_dist = mm02d_birds_dist_fr, SR_dist = mm02d_birds_dist_sr)
mammals_dist_models <- list(PD_dist = mm02d_mammals_dist_pd, FR_dist = mm02d_mammals_dist_fr, SR_dist = mm02d_mammals_dist_sr)

# size_models <- c(bird_size_models, mammals_size_models)
# dist_models <- c(bird_dist_models, mammals_dist_models)
```

```{r rpr_cor_spill_tab, echo = FALSE, message = FALSE, warning = FALSE, eval = TRUE}

# Define variable convert table
var_cvt <- data.frame(
    term = c("R2", "(Intercept)", "gedi.m", "access_log10.z", 
             "HDI.z", "PA", "dist_to_PA.z", "BigPA",
             "PA_size_km2.z", "CloseToPA"),
    Variable = c("$R^{2}$", "Intercept", "Forest canopy height",
                 "Site accessibility", "HDI", "PA", 
                  "Distance to PA", "PA size (binary)","PA size", 
                 "Distance to PA (binary)"))

mods <- list("bird" = do.call(c, list(bird_size_models, bird_dist_models)), 
             "mammal" = do.call(c, list(mammals_size_models, mammals_dist_models)))

coefs <- lapply(names(mods), function(taxon){
    models <- mods[[taxon]]
    lapply(names(models), function(nm){
        # Extract names for identity
        var_nm <- toupper(strsplit(nm, "_")[[1]][1])
        effect_nm <- strsplit(nm, "_")[[1]][2]
        effect_nm <- ifelse(effect_nm == 'size', 
                                   "Outside protected areas - 'PA size' effect",
                                   "Outside protected areas - 'Distance to PA' effect")
        r_square <- r.squaredGLMM(models[[nm]])[[2]]
        
        # Do the tidy work
        broom.mixed::tidy(
            models[[nm]], effects='fixed', conf.int = TRUE) %>% 
            mutate(report_value = sprintf("%.3f\n(%.3f; %.3f)", 
                                          estimate, std.error, p.value)) %>% 
            select(term, report_value) %>% 
            rbind(c("R2", sprintf("%.3f", r_square)), .) %>% 
            left_join(var_cvt, by = "term") %>% 
            mutate(var_nm = var_nm, Effect = effect_nm) %>% 
            select(Effect, Variable, report_value, var_nm)
    }) %>% 
        bind_rows() %>% 
        mutate(var_nm = factor(var_nm, levels = c("SR", "FR", "PD"))) %>% 
        arrange(var_nm) %>% 
        pivot_wider(names_from = var_nm, values_from = report_value)
})
coefs <- left_join(coefs[[1]], coefs[[2]], by = c("Variable", "Effect"),
                       suffix = sprintf(".%s", c("Birds", "Mammals")))

# Manipulate the table
effects <- unique(coefs$Effect)
row_1 <- which(coefs$Effect == effects[1])
row_2 <- which(coefs$Effect == effects[2])
coefs <- coefs %>% 
    select(-Effect) %>% 
    mutate_all(linebreak)

# Bold some cells
row_ids <- which(coefs$Variable %in% 
                     c("PA",
                        "PA size (binary)",
                        "Distance to PA (binary)"))
detec_sig <- coefs[row_ids, -1]
detec_sig <- do.call(cbind, lapply(1:ncol(detec_sig), function(i){
    as.numeric(sapply(detec_sig[[i]], function(x){
        str_extract(x, "(?<=;[[:space:]]).*?(?=\\))")}))
}))
detec_sig <- detec_sig <= 0.05
bold_ids <- matrix(data = FALSE, nrow = nrow(coefs), ncol = ncol(coefs))
bold_ids[row_ids, 1:ncol(detec_sig) + 1] <- detec_sig

for (i in 1:nrow(bold_ids)){
    for (j in 1:ncol(bold_ids)){
        if (bold_ids[i, j] == TRUE){
            coefs[i, j] <- cell_spec(coefs[i, j], bold = T, escape = FALSE)
        }
    }
}

# Make the kable
names(coefs) <- c("Variable", "SR", "FR", "PD", "SR", "FR", "PD")
cap <- paste0("Reproduction results from mixed-effects linear regression for ",
              "species richness (SR), functional richness (FR), ",
              "and phylogenetic diversity (PD) for spillover effects. Following Brodie et al., 
              bolding indicates predictors with estimated coefficients with 
              p<0.05")
coefs %>%
    kableExtra::kbl(escape = FALSE, full_width = FALSE, booktabs = TRUE,
                    caption = cap) %>%     
    kable_paper() %>% 
    kable_styling(latex_options = c("scale_down", "hold_position"), 
                  font_size = 10) %>% 
    pack_rows(effects[1], min(row_1), max(row_1), latex_gap_space = "1em") %>%
    pack_rows(effects[2], min(row_2), max(row_2), latex_gap_space = "1em") %>% 
    add_header_above(c(" " = 1, "Bird" = 3, "Mammal" = 3),
                     align = "c") 
# %>%
#    save_kable(here('results/figures/RPR-cor-spill-table.png'))
```


# Discussion & Conclusion

The goal of the report is to reproduce analysis and results from Brodie et al. (2023) on the effect of protected areas to preserve tropical bird and mammal biodiversity after removing confounding effects of site accessibility and forest structure. 
The original paper provided scripts and data which allowed for reproductions. The scripts were in general reproducible while missing data preprocessing steps such as cleaning protected area boundaries and computing secondary variables from raw data (e.g., GEDI metrics and circuit-based accessibiltiy metrics). 
The data file contained most information necessary to attempt the reproducetion, but did not include raw observation data or an extensive metadata file.

While there are ways to improve the reproducibility of the original work, our reproduction found results that were consistent with the main findings of Brodie et al. (2023). 
We found supporting evidence for OR-H1 (i.e., similar coefficient values and significance) as the original study but were unable to reproduce exact results as Brodie et al. (2023). 
Reasons for the differences could be data version issues or computation environment.

## Bias and threats to validity

Given the research design as described in the original paper and primary data shared, we find that potential spatial autocorrelation of sample points were not addressed. In addition, uncertainty issues were not discussed thoroughly in the paper, which includes 1) the representativeness of biodiversity measures, 2) the validity of forest structure measures created through krigging, and 3) accessibility represented by country-level Human Development Index.


# Acknowledgements

This report is based upon the template for Reproducible and Replicable Research in Human-Environment and Geographical Sciences, DOI:[10.17605/OSF.IO/W29MQ](https://doi.org/10.17605/OSF.IO/W29MQ)

# References
Brodie, J.F., Mohd-Azlan, J., Chen, C. et al. Landscape-scale benefits of protected areas for tropical biodiversity. Nature 620, 807â€“812 (2023). <https://doi.org/10.1038/s41586-023-06410-z>