---
title: "Replication Report for Brodie et al. (2023) "
author: "Peter Kedron, Lei Song, Wenxin Yang, Amy Frazier"
date: "`r Sys.Date()`"
output: 
  pdf_document:
    toc: false
    number_sections: true
editor_options:
  markdown:
    wrap: sentence
knit: (function(inputFile, encoding) {
  rmarkdown::render(inputFile, encoding = encoding, output_dir = "../../docs/report") })
---

```{r chunk setup, include = FALSE, message = FALSE}
# Record packages
packages <- c("tidyverse", "here")

# force all conflicts to become errors
require(conflicted)
library(here)
library(kableExtra)

# load and install required packages
if (!require(groundhog)) {
  install.packages("groundhog")
  require(groundhog)
}

# record the R processing environment
writeLines(
  capture.output(sessionInfo()),
  here("procedure", "environment", paste0("r-environment-", Sys.Date(), ".txt"))
)

# save package citations
knitr::write_bib(c(packages, "base"), file = here("software.bib"))

# set up default knitr parameters
# https://yihui.org/knitr/options/
knitr::opts_chunk$set(
  echo = FALSE, # Run code, show outputs (don't show code)
  fig.retina = 4,
  fig.width = 8,
  fig.path = paste0(here("results", "figures"), "/"),
  warning = FALSE,
  message = FALSE
)

# set working directory as the project folder
knitr::opts_knit$set(root.dir = here(''))
options(tinytex.verbose = TRUE)
```

# Introduction
This study is a *replication* of:

> Brodie, J.F., Mohd-Azlan, J., Chen, C. et al. Landscape-scale benefits of protected areas for tropical biodiversity. Nature 620, 807â€“812 (2023). [https://doi.org/10.1038/s41586-023-06410-z](https://doi.org/10.1038/s41586-023-06410-z)

Using a causal framework that controls for forest structure, site accessibility, and geographic location through matching, Brodie et al. (2023) find evidence that protected areas (PA) preserve vertebrate biodiversity within their boundaries and in the adjacent unprotected landscape. 
While Brodie et al. provide evidence of the efficacy of protected area status, they do not assess whether the effect they observe is altered by the connectedness of the protected area network.
PA connectivity is widely recognized as a component of effective conservation, a guiding principle of the 30x30 initiative, and a possible confound of the effect of protection on biodiversity. 
Ecologically, the connectedness of a PA network may affect biodiversity by facilitating gene flow across locations, which may moderate the effect of protection on biodiversity.

To adjust for effect of connectivity on PA efficacy, we computationally reproduced the findings of Brodie et al. using the data shared by the authors, and extended the original analysis by introducing habitat connectivity as an independent predictor of biodiversity and a moderator of the PA effect.
We find that ...

This document presents our replication and extension of Brodie et al. (2023). 
Our computational reproduction of the authors' original analysis is presented in *Reproduction Report for Brodie et al. (2023)*.
All data and materials needed to fully reproduce the results of this paper are publicly available at GitHub (LINK) with the identifier PROJECT DOI and Figshare (LINK) with the identifier DATA DOI.


# Study design
We adopt the statistical approach of the original analysis and test the sensitivity of the authors' findings to PA connectivity. 
Using propensity score matching to control for the confounds of location, site accessibility, and forest structure, Brodie et al. fit a linear mixed-effects model to measure the effect of PA status on bird and mammal biodiversity.
The response variable examined in the study were three measures of biodiversity measured for both mammals and birds - Species richness (SR), Functional richness (FR), and Phylogenetic diversity (PD).
The response variables were derived from 1,079 sampling locations in the eBird database and 1,365 camera stations deployed across the region. 
The primary predictor of interest was a binary measure indicating whether a observation site was located inside or outside a PA.
Predictor variables measuring PA status, site accessibility, forest structure, understory density, and human development pressure were derived from the World Database of Protected Areas, the NASA Global Ecosystem Dynamics Investigation (GEDI) mission, and the UN Development program Human Development Index.

We conduct two related analyses to evaluate and extend the work of the Brodie et al. (2023). 

First, we introduce PA connectivity as a predictor of bird and mammal biodiversity and a moderator of PA efficacy.
Brodie et al. find evidence that the legal designation of PAs enhances Southeast Asian bird biodiversity.
The authors did not find the same effect for mammals. 
Our primary hypotheses are:

> HA-1a: The protected area status of a site alters the level of mammal and bird biodiversity observed at that site when adjusting for the confounds of site accessibility, habitat condition, socioeconomic development, **and protected area connectivity**.

> HA-1b: How connected a site is to surrounding protected areas moderates the effect protected area status has on the level of mammal and bird biodiversity observed at that site when adjusting for the confounds of site accessibility, habitat condition, socioeconomic development.

Second, we examine whether the beneficial spillover effects observed around PAs persist when adjusting for PA connectivity.
Brodie et al. find evidence that large PAs are associated with higher biodiversities for mammals and birds in surrounding unprotected areas, but also that the effects for birds are smaller than those for mammals.
The authors found that distance to the nearest PA was significantly associated with only mammal biodiversity.
Our primary hypotheses are:

> HA-2a: The total area of the protected area located closest to an unprotected observation site alters the level of mammalian of avian biodiversity observed at that site when adjusting for the confounds of site accessibility, habitat condition, and the socioeconomic development, **and protected area connectivity**.

> HA-2b: The distance to the protected area located closest to an unprotected observation site alters on the level of mammalian of avian biodiversity observed at that site when adjusting for the confounds of site accessibility, habitat condition, and the socioeconomic development, **and protected area connectivity**..


# Materials and Procedure

## Computational Reproduction
This replication attempt builds on our computational reproduction of Brodie et al. (2023).
We use the same computational environments, data, and data preparation procedure adopted in that work. 
Complete details of the materials and methods use are available in *Reproduction Report for Brodie et al. (2023)* and can be evaluated in depth by examining the functions called throughout this document. 
All materials and procedures are publicly available at GitHub **(LINK)** with the identifier **PROJECT DOI**.

```{r package setup, echo = TRUE, results = 'hide', message = FALSE, warning = FALSE, eval = FALSE}
source(here("procedure/code/kick_off.R"))
# Load required packages and scripts
kick_off('procedure/code')
```

## Connectivity Measures
We measured site connectivity as the area-weighted flux (AWF) of species observation sites and the surrounding landscape. 
Area-weighted flux measures flow, weighted by protected area, between all sites as

\begin{align*}
AWF=  
p_{ij}=e^{-k*d_{ij}} 
\end{align*}

where 
$p_{ij}$ is the probability of dispersal between two sites $i$ and $j$, $k$ is a median dispersal distance at which $p_{ij} = 0.5$, and $d_{ij}$ is the observed distance between $i$ and $j$. 

To construct our site and PA connectivity measures, we independently gathered data on PA geographies from the the World Database on Protected Areas [https://www.protectedplanet.net/en/thematic-areas/wdpa?tab=WDPA](https://www.protectedplanet.net/en/thematic-areas/wdpa?tab=WDPA).
**Lei, insert description of how AWF was adapted to all sites here. Touch on processing of PAs, restricting mammals to land bodies, thresholds used, etc.**

```{r calculate_conn, eval=FALSE, echo=TRUE, results='hide', message=FALSE}
# Calculate site connectivity for birds and mammals
calc_conn(taxon = "bird", src_dir = src_dir, dst_dir = dst_dir)
calc_conn(taxon = "mammal", src_dir = src_dir, dst_dir = dst_dir)
```

## Preparation of the Analytical Data Files
Preparation of our analytical data file followed the procedures outlined in Brodie et al. (2023) and implemented in our computational reproduction. 
Because that analysis did not analyze connectivity, we appended our calculated connectivity measures to that datafile and scaled those variables following the procedures of the original authors.
Finally, we identified and removed outlier values from each dataset using **PROCEDURE INFO** and a list provided by Brodie et al. 

```{r clean_data, eval=FALSE, echo=TRUE, results='hide', message=FALSE}
# Load Brodie outlier list
## For PA efficacy
outliers_eff_bird <- list(
    "PD" = c("L2422371", "L3776738", "L2521761", 
             "L6127181", "L3865754"),
    "FR" = c("L921125", "L2422371", "L4331944", "L13465594"),
    "SR" = c("L4789498", "L921125", "L1122096", 
             "L7010824", "L3865754", "L3776738"))

# For spillover
outliers_spil_bird <- list(
    "PD" = c("L1084299", "L4225511", "L3846512", "L2129865", "L3267752"),
    "FR" = c("L4225511", "L5969878", "L3267752", 
             "L4331944", "L13465594", "L1084299"),
    "SR" = c("L4225511", "L5624588", "L3321319", "L14087870"))
outliers_spil_mammal <- list(
    "PD" = c("WM-OP009", "WM-HCV003", "C24A25", "C1A09", "C1B12"),
    "FR" = c("Bal013a", "Bal017a", "C1CT21"),
    "SR" = c("Bal011", "C1CT50", "C24A25"))

# Clean data and remove outliers for bird and mammal models
conn_metrics <- 'awf_ptg'
src_dir <- "data/raw/public"
conn_dir <- "data/derived/public"
dst_dir <- "data/derived/public"
dat_clean_bird <- clean_data("bird", conn_metrics, src_dir, conn_dir, dst_dir)
dat_clean_mammal <- clean_data("mammal", conn_metrics, src_dir, conn_dir, dst_dir)
```

# Statistical Results

## STATEMENT OF FIND Efficacy
We first used propensity score matching and a linear mixed effects model to assessed whether the finding that PA preserve vertebrate biodiversity within their boundaries persisted when adjusting for connectivity.
Here we report connectivity results using a 100km threshold.

```{r rpl_eff, eval=FALSE, echo=TRUE, results='hide', message=FALSE}
# Make a common catalog
var_catalog <- data.frame(
    response_variable = c("asymptPD", "maxFRic", "SR.mean"), 
    name = c("PD", "FR", "SR"))

# Reproduce models for birds
dat_clean_bird <- subset(dat_clean_bird, med_dist == 100)
rpl_efficacy_bird <- lapply(1:nrow(var_catalog), function(i){
    model_pa_efficacy(dat_clean_bird, "connec", "bird",
                      var_catalog[[i, "response_variable"]], 
                      # set to auto for auto detection
                      outliers_eff_bird[[var_catalog[[i, "name"]]]]) 
}); names(rpl_efficacy_bird) <- sprintf("mod_bird_eff_%s", var_catalog$name)

# Reproduce models for mammals
dat_clean_mammal <- subset(dat_clean_mammal, med_dist == 50)
rpl_efficacy_mammal <- lapply(1:nrow(var_catalog), function(i){
    model_pa_efficacy(dat_clean_mammal, "connec", "mammal",
                      var_catalog[[i, "response_variable"]], 
                      # set to auto for auto detection
                      NULL)
}); names(rpl_efficacy_mammal) <- sprintf("mod_mammal_eff_%s", var_catalog$name)
```

## Linear Mixed Effects Model of PA Spillovers

```{r rpl_spill, eval=FALSE, echo=TRUE, results='hide', message=FALSE}
# Replicate spillover models for birds w/ connectivity
## Lei, we need to change the outlier procedure in this function
rpl_spill_bird <- lapply(1:nrow(var_catalog), function(i){
    mods <- lapply(c("BigPA", "CloseToPA"), function(bnr_var){
        model_pa_spillover(dat_clean_bird, "connec+", "bird", bnr_var, 
                       var_catalog[[i, "response_variable"]], 
                      outliers_spil_bird[[var_catalog[[i, "name"]]]])
    })
    names(mods) <- sprintf("mod_bird_%s_%s", 
                           c("size", "dist"), var_catalog[[i, "name"]])
    mods
    
})
rpl_spill_bird <- do.call(c, rpl_spill_bird)

# Replicate spillover models for mammals w/ connectivity
## Lei, we need to change the outlier procedure in this function
rpl_spill_mammal <- lapply(1:nrow(var_catalog), function(i){
    mods <- lapply(c("BigPA", "CloseToPA"), function(bnr_var){
        model_pa_spillover(dat_clean_mammal, "connec+", "mammal", bnr_var, 
                       var_catalog[[i, "response_variable"]], 
                      outliers_spil_mammal[[var_catalog[[i, "name"]]]])
    })
    names(mods) <- sprintf("mod_mammal_%s_%s", 
                           c("size", "dist"), var_catalog[[i, "name"]])
    mods
    
})
rpl_spill_mammal <- do.call(c, rpl_spill_mammal)
```

```{r rpl_spill_tab, echo = FALSE, message = FALSE, warning = FALSE, eval = TRUE}
# Insert code to construct a summary table of efficacy models like Table 1 in Brodie et al.
# Define variable convert table
var_cvt <- data.frame(
    term = c("R2", "(Intercept)", "forest_structure", "access_log10.z", 
             "HDI.z", "PA", "connectivity.z", "PA:connectivity.z",
             "dist_to_PA.z", "BigPA", "BigPA:connectivity.z",
             "PA_size_km2.z", "CloseToPA", "CloseToPA:connectivity.z"),
    Variable = c("$R^{2}$", "(Intercept)", "Forest canopy height",
                 "Site accessibility", "HDI", "PA", "Connectivity",
                 "PA|Connectivity", "Distance to PA", "PA size (binary)",
                 "PA size|Connectivity", "PA size", 
                 "Distance to PA (binary)", "Distance to PA|Connectivity"))

mods <- list("bird" = do.call(c, list(rpl_efficacy_bird, rpl_spill_bird)), 
             "mammal" = do.call(c, list(rpl_efficacy_mammal, rpl_spill_mammal)))
coefs <- lapply(names(mods), function(taxon){
    models <- mods[[taxon]]
    lapply(names(models), function(nm){
        # Extract names for identity
        var_nm <- toupper(strsplit(nm, "_")[[1]][4])
        effect_nm <- strsplit(nm, "_")[[1]][3]
        effect_nm <- ifelse(effect_nm == "eff", "All sites",
                            ifelse(effect_nm == 'size', 
                                   "Outside protected areas - 'PA size' effect",
                                   "Outside protected areas - 'Distance to PA' effect"))
        r_square <- r.squaredGLMM(models[[nm]])[[2]]
        
        # Do the tidy work
        broom.mixed::tidy(
            models[[nm]], effects='fixed', conf.int = TRUE) %>% 
            mutate(report_value = sprintf("%.3f (%.3f; %.3f)", 
                                          estimate, std.error, p.value)) %>% 
            select(term, report_value) %>% 
            rbind(c("R2", sprintf("%.3f", r_square)), .) %>% 
            left_join(var_cvt, by = "term") %>% 
            mutate(var_nm = var_nm, Effect = effect_nm) %>% 
            select(Effect, Variable, report_value, var_nm)
    }) %>% bind_rows() %>% 
        mutate(var_nm = factor(var_nm, levels = c("SR", "FR", "PD"))) %>% 
        arrange(var_nm) %>% 
        pivot_wider(names_from = var_nm, values_from = report_value)
})
coefs <- left_join(coefs[[1]], coefs[[2]], by = c("Variable", "Effect"),
                       suffix = sprintf(".%s", c("Birds", "Mammals")))

# Manipulate the table
effects <- unique(coefs$Effect)
row_1 <- which(coefs$Effect == effects[1])
row_2 <- which(coefs$Effect == effects[2])
row_3 <- which(coefs$Effect == effects[3])
coefs <- coefs %>% select(-Effect)

# Bold some cells
row_ids <- which(coefs$Variable %in% 
                     c("PA", "Connectivity",
                       "PA|Connectivity", "PA size (binary)",
                       "PA size|Connectivity", "Distance to PA (binary)",
                       "Distance to PA|Connectivity"))
detec_sig <- coefs[row_ids, -1]
detec_sig <- do.call(cbind, lapply(1:ncol(detec_sig), function(i){
    as.numeric(sapply(detec_sig[[i]], function(x){
        str_extract(x, "(?<=;[[:space:]]).*?(?=\\))")}))
}))
detec_sig <- detec_sig <= 0.05
bold_ids <- matrix(data = FALSE, nrow = nrow(coefs), ncol = ncol(coefs))
bold_ids[row_ids, 1:ncol(detec_sig) + 1] <- detec_sig

for (i in 1:nrow(bold_ids)){
    for (j in 1:ncol(bold_ids)){
        if (bold_ids[i, j] == TRUE){
            coefs[i, j] <- cell_spec(coefs[i, j], bold = T)
        }
    }
}

# Make the kable
names(coefs) <- c("Variable", "SR", "FR", "PD", "SR", "FR", "PD")
coefs %>%
    kableExtra::kbl(escape = FALSE) %>% 
    kable_classic(full_width = F) %>%
    pack_rows(effects[1], min(row_1), max(row_1)) %>%
    pack_rows(effects[2], min(row_2), max(row_2)) %>% 
    pack_rows(effects[3], min(row_3), max(row_3)) %>% 
    add_header_above(c(" " = 1, "Bird" = 3, "Mammal" = 3),
                     align = "c")
```

**<< Insert Table comparing Replication and Brodie using simplified typology >>**

**<< Insert Table comparing Spillover Replication and Brodie using simplified typology >>**

# Sensitivity Analyses
Compile models runs all the functions above and produces x...

```{r compile_models, echo = TRUE, message = FALSE, warning = FALSE, eval = FALSE}
for (dist in seq(10, 150, 10)){
    compile_models(taxon = "bird", med_dist = dist,
                   src_dir = "data/derived/public", 
                   dst_dir = "results")
    compile_models(taxon = "mammal", med_dist = dist,
                   src_dir = "data/derived/public", 
                   dst_dir = "results")
}

# Generate plots
plot_dist_effect(src_dir = "results", dst_dir = "results/figures")
```


```{r, bird_eff_dist, echo = FALSE, message = FALSE, warning = FALSE, eval = TRUE}
load(here("results/figures/plot_dist_effect_taxons.rda"))

# Birds 3x3 efficacy result over distance
taxon_dist_plot$bird$`Phylogenetic diveristy (PD)` +
    ggtitle(paste0("Bird", " - ", "Phylogenetic diveristy (PD)")) +
    theme(plot.title = element_text(hjust = 0.5))
taxon_dist_plot$bird$`Functional richness (FR)` +
    ggtitle(paste0("Bird", " - ", "Functional richness (FR)")) +
    theme(plot.title = element_text(hjust = 0.5))
taxon_dist_plot$bird$`Species richness (SR)` +
    ggtitle(paste0("Bird", " - ", "Species richness (SR)")) +
    theme(plot.title = element_text(hjust = 0.5))
```

```{r, mammal_eff_dist, echo = FALSE, message = FALSE, warning = FALSE, eval = TRUE}
# Mammals 3x3 efficacy result over distance
taxon_dist_plot$mammal$`Phylogenetic diveristy (PD)` +
    ggtitle(paste0("Mammal", " - ", "Phylogenetic diveristy (PD)")) +
    theme(plot.title = element_text(hjust = 0.5))
taxon_dist_plot$mammal$`Functional richness (FR)` +
    ggtitle(paste0("Mammal", " - ", "Functional richness (FR)")) +
    theme(plot.title = element_text(hjust = 0.5))
taxon_dist_plot$mammal$`Species richness (SR)` +
    ggtitle(paste0("Mammal", " - ", "Species richness (SR)")) +
    theme(plot.title = element_text(hjust = 0.5))
```

# Discussion

